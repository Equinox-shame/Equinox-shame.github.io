
<!DOCTYPE html>
<html lang="en" class="loading">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CSAPP - Bomb Lab - Autumnal</title>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="google" content="notranslate" />
    <meta name="keywords" content="Fechin,"> 
    <meta name="description" content="Bomb Labphase_1第一关整体上就是比较字符串，判断输入的字符串于目的字符串不一样的时候炸弹就发生爆炸。

输入比较的字符串即可通过第一关：
1Border relations with ,"> 
    <meta name="author" content="John Doe"> 
    <link rel="alternative" href="atom.xml" title="Autumnal" type="application/atom+xml"> 
    <link rel="icon" href="/img/favicon.png"> 
    
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">

    
<link rel="stylesheet" href="/css/diaspora.css">

<meta name="generator" content="Hexo 5.4.0"></head>

<body class="loading">
    <span id="config-title" style="display:none">Autumnal</span>
    <div id="loader"></div>
    <div id="single">
    <div id="top" style="display: block;">
    <div class="bar" style="width: 0;"></div>
    <a class="iconfont icon-home image-icon" href="javascript:;" data-url="http://example.com"></a>
    <div title="播放/暂停" class="iconfont icon-play"></div>
    <h3 class="subtitle">CSAPP - Bomb Lab</h3>
    <div class="social">
        <div>
            <div class="share">
                <a title="获取二维码" class="iconfont icon-scan" href="javascript:;"></a>
            </div>
            <div id="qr"></div>
        </div>
    </div>
    <div class="scrollbar"></div>
</div>

    <div class="section">
        <div class="article">
    <div class='main'>
        <h1 class="title">CSAPP - Bomb Lab</h1>
        <div class="stuff">
            <span>四月 03, 2022</span>
            

        </div>
        <div class="content markdown">
            <h1 id="Bomb-Lab"><a href="#Bomb-Lab" class="headerlink" title="Bomb Lab"></a>Bomb Lab</h1><h2 id="phase-1"><a href="#phase-1" class="headerlink" title="phase_1"></a>phase_1</h2><p>第一关整体上就是比较字符串，判断输入的字符串于目的字符串不一样的时候炸弹就发生爆炸。</p>
<p><img src="https://s2.loli.net/2022/04/01/RUQlt7WoYAdcub1.png"></p>
<p>输入比较的字符串即可通过第一关：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Border relations with Canada have never been better.</span><br></pre></td></tr></table></figure>

<h2 id="phase-2"><a href="#phase-2" class="headerlink" title="phase_2"></a>phase_2</h2><p>第二关的伪代码看起来十分的难看，所以我们直接看汇编。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">text:0000000000400EFC push    rbp</span><br><span class="line">.text:0000000000400EFD push    rbx</span><br><span class="line">.text:0000000000400EFE sub     rsp, 28h</span><br><span class="line">.text:0000000000400F02 mov     rsi, rsp</span><br><span class="line">.text:0000000000400F05 call    read_six_numbers</span><br><span class="line">.text:0000000000400F05</span><br><span class="line">.text:0000000000400F0A cmp     [rsp+38h+var_38], 1   ; 第一个开始为1</span><br><span class="line">.text:0000000000400F0A                               ; 输入的数偏移依次为38 34 30 26 22 18</span><br><span class="line">.text:0000000000400F0E jz      short loc_400F30      ; 将输入的值从第二个开始取</span><br><span class="line">.text:0000000000400F0E                               ; 刚好对应上面便宜量为38，此处为34，向下取了4个单位的地址</span><br><span class="line">.text:0000000000400F0E</span><br><span class="line">.text:0000000000400F10 call    explode_bomb</span><br><span class="line">.text:0000000000400F10</span><br><span class="line">.text:0000000000400F15 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0000000000400F15 jmp     short loc_400F30      ; 将输入的值从第二个开始取</span><br><span class="line">.text:0000000000400F15                               ; 刚好对应上面便宜量为38，此处为34，向下取了4个单位的地址</span><br><span class="line">.text:0000000000400F15</span><br><span class="line">.text:0000000000400F17 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0000000000400F17</span><br><span class="line">.text:0000000000400F17 loc_400F17:                   ; CODE XREF: phase_2+30↓j</span><br><span class="line">.text:0000000000400F17                               ; phase_2+3E↓j</span><br><span class="line">.text:0000000000400F17 mov     eax, [rbx-4]          ; 取输入的奇数个存放到eax</span><br><span class="line">.text:0000000000400F1A add     eax, eax              ; eax * 2</span><br><span class="line">.text:0000000000400F1C cmp     [rbx], eax            ; 输入的偶数个等于上一个数的两倍</span><br><span class="line">.text:0000000000400F1E jz      short loc_400F25      ; 向下取4个字节</span><br><span class="line">.text:0000000000400F1E</span><br><span class="line">.text:0000000000400F20 call    explode_bomb</span><br><span class="line">.text:0000000000400F20</span><br><span class="line">.text:0000000000400F25 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0000000000400F25</span><br><span class="line">.text:0000000000400F25 loc_400F25:                   ; CODE XREF: phase_2+22↑j</span><br><span class="line">.text:0000000000400F25 add     rbx, 4                ; 向下取4个字节</span><br><span class="line">.text:0000000000400F29 cmp     rbx, rbp              ; 不为0就跳转</span><br><span class="line">.text:0000000000400F2C jnz     short loc_400F17      ; 取输入的奇数个存放到eax</span><br><span class="line">.text:0000000000400F2C</span><br><span class="line">.text:0000000000400F2E jmp     short loc_400F3C</span><br><span class="line">.text:0000000000400F2E</span><br><span class="line">.text:0000000000400F30 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0000000000400F30</span><br><span class="line">.text:0000000000400F30 loc_400F30:                   ; CODE XREF: phase_2+12↑j</span><br><span class="line">.text:0000000000400F30                               ; phase_2+19↑j</span><br><span class="line">.text:0000000000400F30 lea     rbx, [rsp+38h+var_34] ; 将输入的值从第二个开始取</span><br><span class="line">.text:0000000000400F30                               ; 刚好对应上面便偏移为38，此处为34，向下取了4个单位的地址</span><br><span class="line">.text:0000000000400F35 lea     rbp, [rsp+38h+var_20] ; %rbp=0</span><br><span class="line">.text:0000000000400F3A jmp     short loc_400F17      ; 取输入的奇数个存放到eax</span><br><span class="line">.text:0000000000400F3A</span><br><span class="line">.text:0000000000400F3C ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0000000000400F3C</span><br><span class="line">.text:0000000000400F3C loc_400F3C:                   ; CODE XREF: phase_2+32↑j</span><br><span class="line">.text:0000000000400F3C add     rsp, 28h</span><br><span class="line">.text:0000000000400F40 pop     rbx</span><br><span class="line">.text:0000000000400F41 pop     rbp</span><br><span class="line">.text:0000000000400F42 retn</span><br><span class="line">.text:0000000000400F42 ; &#125; // starts at 400EFC</span><br><span class="line">.text:0000000000400F42</span><br></pre></td></tr></table></figure>

<p>通过对汇编的调试与分析可以得到相关的逻辑，程序会对输入的第一个数进行判断，不为 1 则引爆炸弹，之后的每一项都是前一项的两倍，一共输入 6 个数字，则有对应输入为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1 2 4 8 16 32</span><br></pre></td></tr></table></figure>

<h2 id="phase-3"><a href="#phase-3" class="headerlink" title="phase_3"></a>phase_3</h2><p>第三关整体上也比较简单，让输入两个数，通过第一个数跳到对应的<code>case</code>段，将<code>result</code>进行赋值，之后与输入的第二个数进行比较，不相等就爆炸。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">phase_3</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// [rsp+8h] [rbp-10h] BYREF</span></span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// [rsp+Ch] [rbp-Ch] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">int</span>)__isoc99_sscanf(a1, <span class="string">&quot;%d %d&quot;</span>, &amp;v2, &amp;v3) &lt;= <span class="number">1</span> ) <span class="comment">// 输入两个数字</span></span><br><span class="line">    explode_bomb();</span><br><span class="line">  <span class="keyword">switch</span> ( v2 )	<span class="comment">//第一个数字用于决定result的值</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">      result = <span class="number">0xCF</span>LL;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">      result = <span class="number">0x137</span>LL;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">      result = <span class="number">0x2C3</span>LL;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">      result = <span class="number">0x100</span>LL;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">      result = <span class="number">0x185</span>LL;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">      result = <span class="number">0xCE</span>LL;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">      result = <span class="number">0x2AA</span>LL;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">      result = <span class="number">0x147</span>LL;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      explode_bomb();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( (_DWORD)result != v3 )<span class="comment">//将输入的第二个数字与 result 进行比较，相等则通过。</span></span><br><span class="line">    explode_bomb();</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="phase-4"><a href="#phase-4" class="headerlink" title="phase_4"></a>phase_4</h2><p>程序的逻辑也比较简单，输入两个数字，将第一个数字送到对应的递归中，获得的返回值必须为<code>0</code> ，同时第二个数字也要为<code>0</code>，两个值均为<code>0</code>的情况下成功</p>
<img src="https://s2.loli.net/2022/04/02/yl8pm5FITsdcLVa.png" style="zoom:100%;" /> 

<p>同时递归为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">func4</span><span class="params">(__int64 a1, __int64 a2, __int64 a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// ecx</span></span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  v3 = ((<span class="keyword">int</span>)a3 - (<span class="keyword">int</span>)a2) / <span class="number">2</span> + a2;            <span class="comment">// 7</span></span><br><span class="line">  <span class="keyword">if</span> ( v3 &gt; (<span class="keyword">int</span>)a1 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span> * (<span class="keyword">unsigned</span> <span class="keyword">int</span>)func4(a1, a2, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(v3 - <span class="number">1</span>));</span><br><span class="line">  result = <span class="number">0LL</span>;                                 <span class="comment">// v3 == a1 </span></span><br><span class="line">  <span class="keyword">if</span> ( v3 &lt; (<span class="keyword">int</span>)a1 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span> * (<span class="keyword">unsigned</span> <span class="keyword">int</span>)func4(a1, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(v3 + <span class="number">1</span>), a3) + <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>func4</code>的功能：</p>
<ul>
<li>二分法找出元素x，目标值在数组的前半部分则返回奇数，后半部分则返回偶数；</li>
<li>找到元素x返回0；</li>
<li>如果目标值在二分查找过程中一直在左半边，则会返回0。</li>
</ul>
<p>所以对应的第一个输入值可以为 0 、1 、 3 、7</p>
<p>判断部分有：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">phase_4</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v2; <span class="comment">// [rsp+8h] [rbp-10h] BYREF</span></span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// [rsp+Ch] [rbp-Ch] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)__isoc99_sscanf(a1, <span class="string">&quot;%d %d&quot;</span>, &amp;v2, &amp;v3) != <span class="number">2</span> || v2 &gt; <span class="number">14</span> )</span><br><span class="line">    explode_bomb();</span><br><span class="line">  result = func4(v2, <span class="number">0LL</span>, <span class="number">14LL</span>);                <span class="comment">// 返回值为0</span></span><br><span class="line">  <span class="keyword">if</span> ( (_DWORD)result || v3 )                   <span class="comment">// v3输入为0</span></span><br><span class="line">    explode_bomb();</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过对上述的分析可以得到输入可以为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0 0</span><br><span class="line">1 0</span><br><span class="line">3 0</span><br><span class="line">7 0</span><br></pre></td></tr></table></figure>

<h2 id="phase-5"><a href="#phase-5" class="headerlink" title="phase_5"></a>phase_5</h2><p>第五关其实也是比较简单的一个部分，采用了一个映射表的方式进行加密，将我们的输入与<code>0xF</code>进行<code>&amp;</code>运算形成一个下标，通过这个下标到对应的码表内寻找对应的字符之后进行保存，最后将得到的字符串与<code>flyers</code>进行比较。</p>
<p>加密部分：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 __fastcall <span class="title">phase_5</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 i; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">char</span> v3[<span class="number">8</span>]; <span class="comment">// [rsp+10h] [rbp-18h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v4; <span class="comment">// [rsp+18h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)string_length(a1) != <span class="number">6</span> )   <span class="comment">// 输入字符串长度为6</span></span><br><span class="line">    explode_bomb();</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0LL</span>; i != <span class="number">6</span>; ++i )</span><br><span class="line">    v3[i] = array_3449[*(_BYTE *)(a1 + i) &amp; <span class="number">0xF</span>];</span><br><span class="line">  v3[<span class="number">6</span>] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)strings_not_equal(v3, <span class="string">&quot;flyers&quot;</span>) )</span><br><span class="line">    explode_bomb();</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对应的码表<code>array_3449</code>为：<code>maduiersnfotvbyl</code></p>
<p>对此写一个小脚本进行爆破可行的输入：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">ans = <span class="string">&quot;maduiersnfotvbyl&quot;</span></span><br><span class="line">aim = <span class="string">&quot;flyers&quot;</span></span><br><span class="line">lists = [<span class="number">0</span>]*<span class="number">6</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(aim)):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(ans)):</span><br><span class="line">        <span class="keyword">if</span> aim[i] == ans[j]:</span><br><span class="line">            lists[i] = j</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(lists)</span><br><span class="line">num =<span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> num <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">30</span>,<span class="number">127</span>):</span><br><span class="line">        <span class="keyword">if</span> i &amp; <span class="number">0xF</span> == lists[num]:</span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">chr</span>(i),<span class="string">&quot;-&gt;&quot;</span>,lists[num])</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>有如下输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[9, 15, 14, 5, 6, 7]</span><br><span class="line">) -&gt; 9</span><br><span class="line">9 -&gt; 9</span><br><span class="line">I -&gt; 9</span><br><span class="line">Y -&gt; 9</span><br><span class="line">i -&gt; 9</span><br><span class="line">y -&gt; 9</span><br><span class="line"> -&gt; 15</span><br><span class="line">/ -&gt; 15</span><br><span class="line">? -&gt; 15</span><br><span class="line">O -&gt; 15</span><br><span class="line">_ -&gt; 15</span><br><span class="line">o -&gt; 15</span><br><span class="line"> -&gt; 14</span><br><span class="line">. -&gt; 14</span><br><span class="line">&gt; -&gt; 14</span><br><span class="line">N -&gt; 14</span><br><span class="line">^ -&gt; 14</span><br><span class="line">n -&gt; 14</span><br><span class="line">~ -&gt; 14</span><br><span class="line">% -&gt; 5</span><br><span class="line">5 -&gt; 5</span><br><span class="line">E -&gt; 5</span><br><span class="line">U -&gt; 5</span><br><span class="line">e -&gt; 5</span><br><span class="line">u -&gt; 5</span><br><span class="line">&amp; -&gt; 6</span><br><span class="line">6 -&gt; 6</span><br><span class="line">F -&gt; 6</span><br><span class="line">V -&gt; 6</span><br><span class="line">f -&gt; 6</span><br><span class="line">v -&gt; 6</span><br><span class="line">&#x27; -&gt; 7</span><br><span class="line">7 -&gt; 7</span><br><span class="line">G -&gt; 7</span><br><span class="line">W -&gt; 7</span><br><span class="line">g -&gt; 7</span><br><span class="line">w -&gt; 7</span><br></pre></td></tr></table></figure>

<p>从中对应的字符表进行选取6个对应的字符即可。</p>
<h2 id="phase-6"><a href="#phase-6" class="headerlink" title="phase_6"></a>phase_6</h2><p>在<code>6</code>中的难度明显比前<code>5</code>个要大一些，程序段变得复杂了很多，但是仍然可以通过不断的调试进行判断出来程序的行为。</p>
<blockquote>
<p>程序的函数明显多了很多：</p>
<img src="https://s2.loli.net/2022/04/03/mIbuVKrgG8JxYEl.png" style="zoom:50%;" />
</blockquote>
<p>对于这个较大的“过程”，我们将其一步步进行分析，在上面图的左边部分是程序最开始执行的一部分，在多次循环后进入到右半部分。</p>
<p>这个函数整体的汇编如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line">public phase_6</span><br><span class="line">.text:00000000004010F4     phase_6 proc near             ; CODE XREF: main+126↑p</span><br><span class="line">.text:00000000004010F4</span><br><span class="line">.text:00000000004010F4     input= dword ptr -78h</span><br><span class="line">.text:00000000004010F4     var_60= byte ptr -60h</span><br><span class="line">.text:00000000004010F4     var_58= qword ptr -58h</span><br><span class="line">.text:00000000004010F4     var_50= byte ptr -50h</span><br><span class="line">.text:00000000004010F4     var_28= byte ptr -28h</span><br><span class="line">.text:00000000004010F4</span><br><span class="line">.text:00000000004010F4     ; __unwind &#123;</span><br><span class="line">.text:00000000004010F4 000 push    r14</span><br><span class="line">.text:00000000004010F6 008 push    r13</span><br><span class="line">.text:00000000004010F8 010 push    r12</span><br><span class="line">.text:00000000004010FA 018 push    rbp</span><br><span class="line">.text:00000000004010FB 020 push    rbx</span><br><span class="line">.text:00000000004010FC 028 sub     rsp, 50h              ; Integer Subtraction</span><br><span class="line">.text:0000000000401100 078 mov     r13, rsp</span><br><span class="line">.text:0000000000401103 078 mov     rsi, rsp</span><br><span class="line">.text:0000000000401106 078 call    read_six_numbers      ; Call Procedure</span><br><span class="line">.text:0000000000401106</span><br><span class="line">.text:000000000040110B 078 mov     r14, rsp</span><br><span class="line">.text:000000000040110E 078 mov     r12d, 0</span><br><span class="line">.text:000000000040110E</span><br><span class="line">.text:0000000000401114</span><br><span class="line">.text:0000000000401114     loc_401114:                   ; CODE XREF: phase_6+5D↓j</span><br><span class="line">.text:0000000000401114 078 mov     rbp, r13              ; 返回处偏移加了4</span><br><span class="line">.text:0000000000401117 078 mov     eax, [r13+0]</span><br><span class="line">.text:000000000040111B 078 sub     eax, 1                ; 输入的第一个数字减1</span><br><span class="line">.text:000000000040111E 078 cmp     eax, 5                ; 小于5</span><br><span class="line">.text:0000000000401121 078 jbe     short loc_401128      ; Jump if Below or Equal (CF=1 | ZF=1)</span><br><span class="line">.text:0000000000401121</span><br><span class="line">.text:0000000000401123 078 call    explode_bomb          ; Call Procedure</span><br><span class="line">.text:0000000000401123</span><br><span class="line">.text:0000000000401128     ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0000000000401128</span><br><span class="line">.text:0000000000401128     loc_401128:                   ; CODE XREF: phase_6+2D↑j</span><br><span class="line">.text:0000000000401128 078 add     r12d, 1               ; Add</span><br><span class="line">.text:000000000040112C 078 cmp     r12d, 6               ; 控制循环，共6次</span><br><span class="line">.text:0000000000401130 078 jz      short loc_401153      ; Jump if Zero (ZF=1)</span><br><span class="line">.text:0000000000401130</span><br><span class="line">.text:0000000000401132 078 mov     ebx, r12d</span><br><span class="line">.text:0000000000401132</span><br><span class="line">.text:0000000000401135</span><br><span class="line">.text:0000000000401135     loc_401135:                   ; CODE XREF: phase_6+57↓j</span><br><span class="line">.text:0000000000401135 078 movsxd  rax, ebx              ; Move with Sign-Extend Doubleword</span><br><span class="line">.text:0000000000401138 078 mov     eax, [rsp+rax*4]</span><br><span class="line">.text:000000000040113B 078 cmp     [rbp+0], eax          ; 依次比较，判断每个输入都不同</span><br><span class="line">.text:000000000040113E 078 jnz     short loc_401145      ; 不相等就跳转</span><br><span class="line">.text:000000000040113E</span><br><span class="line">.text:0000000000401140 078 call    explode_bomb          ; Call Procedure</span><br><span class="line">.text:0000000000401140</span><br><span class="line">.text:0000000000401145     ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0000000000401145</span><br><span class="line">.text:0000000000401145     loc_401145:                   ; CODE XREF: phase_6+4A↑j</span><br><span class="line">.text:0000000000401145 078 add     ebx, 1                ; 控制循环，共6次</span><br><span class="line">.text:0000000000401148 078 cmp     ebx, 5                ; Compare Two Operands</span><br><span class="line">.text:000000000040114B 078 jle     short loc_401135      ; Jump if Less or Equal (ZF=1 | SF!=OF)</span><br><span class="line">.text:000000000040114B</span><br><span class="line">.text:000000000040114D 078 add     r13, 4                ; 向下偏移4个字节，取后面输入数字</span><br><span class="line">.text:0000000000401151 078 jmp     short loc_401114      ; 返回处偏移加了4</span><br><span class="line">.text:0000000000401151</span><br><span class="line">.text:0000000000401153     ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0000000000401153</span><br><span class="line">.text:0000000000401153     loc_401153:                   ; CODE XREF: phase_6+3C↑j</span><br><span class="line">.text:0000000000401153 078 lea     rsi, [rsp+24]         ; Load Effective Address</span><br><span class="line">.text:0000000000401158 078 mov     rax, r14</span><br><span class="line">.text:000000000040115B 078 mov     ecx, 7</span><br><span class="line">.text:000000000040115B</span><br><span class="line">.text:0000000000401160</span><br><span class="line">.text:0000000000401160     loc_401160:                   ; CODE XREF: phase_6+79↓j</span><br><span class="line">.text:0000000000401160 078 mov     edx, ecx              ; 7</span><br><span class="line">.text:0000000000401160                                   ; 把ecx的值给edx</span><br><span class="line">.text:0000000000401162 078 sub     edx, [rax]            ; Integer Subtraction</span><br><span class="line">.text:0000000000401164 078 mov     [rax], edx            ; 7 - 每一位输入，将其结果替换为输入的数字中</span><br><span class="line">.text:0000000000401166 078 add     rax, 4                ; 输入数字向下取一位</span><br><span class="line">.text:000000000040116A 078 cmp     rax, rsi              ; 判断是否处理完输入的6个数字</span><br><span class="line">.text:000000000040116D 078 jnz     short loc_401160      ; 7</span><br><span class="line">.text:000000000040116D                                   ; 把ecx的值给edx</span><br><span class="line">.text:000000000040116D</span><br><span class="line">.text:000000000040116F 078 mov     esi, 0</span><br><span class="line">.text:0000000000401174 078 jmp     short loc_401197      ; Jump</span><br><span class="line">.text:0000000000401174</span><br><span class="line">.text:0000000000401176     ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0000000000401176</span><br><span class="line">.text:0000000000401176     loc_401176:                   ; CODE XREF: phase_6+8B↓j</span><br><span class="line">.text:0000000000401176                                   ; phase_6+B5↓j</span><br><span class="line">.text:0000000000401176 078 mov     rdx, [rdx+8]          ; node1向下偏移8字节</span><br><span class="line">.text:000000000040117A 078 add     eax, 1                ; Add</span><br><span class="line">.text:000000000040117D 078 cmp     eax, ecx              ; 找到对应数字所对应的node</span><br><span class="line">.text:000000000040117F 078 jnz     short loc_401176      ; node1向下偏移8字节</span><br><span class="line">.text:000000000040117F</span><br><span class="line">.text:0000000000401181 078 jmp     short loc_401188      ; 存储对应node数据</span><br><span class="line">.text:0000000000401181                                   ; 将node进行保存到输入中，</span><br><span class="line">.text:0000000000401181                                   ; 每次偏移两个单位，当好去除掉了空格</span><br><span class="line">.text:0000000000401181</span><br><span class="line">.text:0000000000401183     ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0000000000401183</span><br><span class="line">.text:0000000000401183     loc_401183:                   ; CODE XREF: phase_6+A9↓j</span><br><span class="line">.text:0000000000401183 078 mov     edx, offset node1</span><br><span class="line">.text:0000000000401183</span><br><span class="line">.text:0000000000401188</span><br><span class="line">.text:0000000000401188     loc_401188:                   ; CODE XREF: phase_6+8D↑j</span><br><span class="line">.text:0000000000401188 078 mov     [rsp+rsi*2+32], rdx   ; 存储对应node数据</span><br><span class="line">.text:0000000000401188                                   ; 将node进行保存到输入中，</span><br><span class="line">.text:0000000000401188                                   ; 每次偏移两个单位，当好去除掉了空格</span><br><span class="line">.text:000000000040118D 078 add     rsi, 4                ; Add</span><br><span class="line">.text:0000000000401191 078 cmp     rsi, 18h              ; 循环6次</span><br><span class="line">.text:0000000000401195 078 jz      short loc_4011AB      ; Jump if Zero (ZF=1)</span><br><span class="line">.text:0000000000401195</span><br><span class="line">.text:0000000000401197</span><br><span class="line">.text:0000000000401197     loc_401197:                   ; CODE XREF: phase_6+80↑j</span><br><span class="line">.text:0000000000401197 078 mov     ecx, [rsp+rsi]</span><br><span class="line">.text:000000000040119A 078 cmp     ecx, 1                ; 取减完后的每一项与1进行比较</span><br><span class="line">.text:000000000040119D 078 jle     short loc_401183      ; 不等于往左，等于往右</span><br><span class="line">.text:000000000040119D</span><br><span class="line">.text:000000000040119F 078 mov     eax, 1</span><br><span class="line">.text:00000000004011A4 078 mov     edx, offset node1     ; 将node1地址给edx</span><br><span class="line">.text:00000000004011A9 078 jmp     short loc_401176      ; node1向下偏移8字节</span><br><span class="line">.text:00000000004011A9</span><br><span class="line">.text:00000000004011AB     ; ---------------------------------------------------------------------------</span><br><span class="line">.text:00000000004011AB</span><br><span class="line">.text:00000000004011AB     loc_4011AB:                   ; CODE XREF: phase_6+A1↑j</span><br><span class="line">.text:00000000004011AB 078 mov     rbx, [rsp+32]</span><br><span class="line">.text:00000000004011B0 078 lea     rax, [rsp+40]         ; Load Effective Address</span><br><span class="line">.text:00000000004011B5 078 lea     rsi, [rsp+80]         ; 将rsi置0</span><br><span class="line">.text:00000000004011BA 078 mov     rcx, rbx</span><br><span class="line">.text:00000000004011BA</span><br><span class="line">.text:00000000004011BD</span><br><span class="line">.text:00000000004011BD     loc_4011BD:                   ; CODE XREF: phase_6+DC↓j</span><br><span class="line">.text:00000000004011BD 078 mov     rdx, [rax]</span><br><span class="line">.text:00000000004011C0 078 mov     [rcx+8], rdx          ; rcx对应node起始地址</span><br><span class="line">.text:00000000004011C4 078 add     rax, 8                ; Add</span><br><span class="line">.text:00000000004011C8 078 cmp     rax, rsi              ; 判断是否循环完毕</span><br><span class="line">.text:00000000004011CB 078 jz      short loc_4011D2      ; Jump if Zero (ZF=1)</span><br><span class="line">.text:00000000004011CB</span><br><span class="line">.text:00000000004011CD 078 mov     rcx, rdx</span><br><span class="line">.text:00000000004011D0 078 jmp     short loc_4011BD      ; Jump</span><br><span class="line">.text:00000000004011D0</span><br><span class="line">.text:00000000004011D2     ; ---------------------------------------------------------------------------</span><br><span class="line">.text:00000000004011D2</span><br><span class="line">.text:00000000004011D2     loc_4011D2:                   ; CODE XREF: phase_6+D7↑j</span><br><span class="line">.text:00000000004011D2 078 mov     qword ptr [rdx+8], 0</span><br><span class="line">.text:00000000004011DA 078 mov     ebp, 5</span><br><span class="line">.text:00000000004011DA</span><br><span class="line">.text:00000000004011DF</span><br><span class="line">.text:00000000004011DF     loc_4011DF:                   ; CODE XREF: phase_6+101↓j</span><br><span class="line">.text:00000000004011DF 078 mov     rax, [rbx+8]          ; 将node中的数据段给rax</span><br><span class="line">.text:00000000004011E3 078 mov     eax, [rax]</span><br><span class="line">.text:00000000004011E5 078 cmp     [rbx], eax            ; 比较后一项和前一项的大小</span><br><span class="line">.text:00000000004011E7 078 jge     short loc_4011EE      ; 后一项的数据小于前一项时跳转</span><br><span class="line">.text:00000000004011E7</span><br><span class="line">.text:00000000004011E9 078 call    explode_bomb          ; Call Procedure</span><br><span class="line">.text:00000000004011E9</span><br><span class="line">.text:00000000004011EE     ; ---------------------------------------------------------------------------</span><br><span class="line">.text:00000000004011EE</span><br><span class="line">.text:00000000004011EE     loc_4011EE:                   ; CODE XREF: phase_6+F3↑j</span><br><span class="line">.text:00000000004011EE 078 mov     rbx, [rbx+8]</span><br><span class="line">.text:00000000004011F2 078 sub     ebp, 1                ; Integer Subtraction</span><br><span class="line">.text:00000000004011F5 078 jnz     short loc_4011DF      ; 将node中的数据段给rax</span><br><span class="line">.text:00000000004011F5</span><br><span class="line">.text:00000000004011F7 078 add     rsp, 50h              ; Add</span><br><span class="line">.text:00000000004011FB 028 pop     rbx</span><br><span class="line">.text:00000000004011FC 020 pop     rbp</span><br><span class="line">.text:00000000004011FD 018 pop     r12</span><br><span class="line">.text:00000000004011FF 010 pop     r13</span><br><span class="line">.text:0000000000401201 008 pop     r14</span><br><span class="line">.text:0000000000401203 000 retn                          ; Return Near from Procedure</span><br><span class="line">.text:0000000000401203     ; &#125; // starts at 4010F4</span><br></pre></td></tr></table></figure>

<p>可以看到有多个函数，我们切换到图形模式：</p>
<p><img src="https://s2.loli.net/2022/04/03/B56OhTHM7mDo8gS.png"><br><img src="https://s2.loli.net/2022/04/03/SBViRqdIFpsQM4x.png"></p>
<p>在左半部分，多次调试壳以判断出对应函数的第一个部分是确保输入不同，采用了两个循环进行遍历。</p>
<p>再看看右半部分：</p>
<p><img src="https://s2.loli.net/2022/04/03/i5wAenhazEGTHSj.png" alt="9.png"></p>
<p>在函数<code>loc_40153</code>、<code>loc_401160</code>中将我们输入的每一位数字用<code>7</code>减去后保存在原来的位置上，完成后跳转到下一个部分。</p>
<p><img src="https://s2.loli.net/2022/04/03/WvKgZBAjRT5bf4h.png" alt="10.png"></p>
<p>在这段程序中我们可以注意到有一个<code>node</code>的偏移，可是打开<code>node</code>查看对应的数据会发现十分的奇怪，但是稍微修复一下可以得到：</p>
<img src="https://s2.loli.net/2022/04/03/8I2od5fy1gwW3z6.png" style="zoom:80%;" />

<p>发现什么了吗？每一个<code>node</code>中都存放着一共偏移量，用来指向另一个<code>node</code>，意味着这个<code>node</code>构成的是一个链表结构，而第一个数据也便是其链表中的数据部分。</p>
<p>我们在调试中可以发现程序将用<code>7</code>减去我们的输入后的数据保存在原来位置上，之后通过<code>loc_401176</code>对整个链表进行遍历，直到我们的输入和寄存器<code>eax</code>中数据大小一致时将链表中的数据进行保存。</p>
<p>遍历完后寄存器<code>rdi</code>中便是对应对应的节点，标号与我们的输入相互对应。</p>
<blockquote>
<p> node1 -&gt; 1     |     node2 -&gt; 2     |    …</p>
</blockquote>
<p>保存之后程序会对我们保存的寄存器值每次取两个，共<code>5</code>次，将寄存器中数据的前一个节点和后一个节点的值进行比较。当后面的数据小于前面的数据时，继续下一次循环，如果出现小于等于时，则引爆炸弹。</p>
<p><img src="https://s2.loli.net/2022/04/03/9d8wQLMt4hNiveX.png"></p>
<blockquote>
<p>更正上图一个错误点，于<code>loc_4011FF</code>处，应该是后一项的数据小于前一项时跳转。</p>
</blockquote>
<p>同过分析我们了解到，<code>phase_6</code>有如下判断条件：</p>
<ul>
<li>输入的六个数字各不相同</li>
<li>用 7 减去对应的输入数字保存在原来输入的地址处</li>
<li>通过遍历链表找到减去后数据对应的链表，取其数据部分保存</li>
<li>循环 5 次，确保每个保存的链表数据值大小小于后一项</li>
</ul>
<p>我们提出对应 6 个节点的大小，有如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">node 1 -&gt; 0x14C	(332)</span><br><span class="line">node 2 -&gt; 0xA8	(168)</span><br><span class="line">node 3 -&gt; 0x39C	(924)</span><br><span class="line">node 4 -&gt; 0x2B3	(691)</span><br><span class="line">node 5 -&gt; 0x1DD	(477)</span><br><span class="line">node 6 -&gt; 0x1BB	(443)</span><br></pre></td></tr></table></figure>

<p>所以排序有：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node 2 &lt; node 1 &lt; node 6 &lt; node 5 &lt; node 4 &lt; node 3 </span><br></pre></td></tr></table></figure>

<p>因为保存的<code>node</code>具体大小是经过<code>7</code>减去后得到的，即输入为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">4 3 2 1 6 5</span><br></pre></td></tr></table></figure>

<h2 id="secret-phase"><a href="#secret-phase" class="headerlink" title="secret_phase"></a>secret_phase</h2><p>当我们完成六个关卡时，会有一个隐藏关卡</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">phase_defused</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> v0; <span class="comment">// [rsp+8h] [rbp-70h] BYREF</span></span><br><span class="line">  <span class="keyword">char</span> v1; <span class="comment">// [rsp+Ch] [rbp-6Ch] BYREF</span></span><br><span class="line">  <span class="keyword">char</span> v2[<span class="number">88</span>]; <span class="comment">// [rsp+10h] [rbp-68h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v3; <span class="comment">// [rsp+68h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)__isoc99_sscanf(&amp;unk_603870, <span class="string">&quot;%d %d %s&quot;</span>, &amp;v0, &amp;v1, v2) == <span class="number">3</span></span><br><span class="line">    &amp;&amp; !(<span class="keyword">unsigned</span> <span class="keyword">int</span>)strings_not_equal(v2, <span class="string">&quot;DrEvil&quot;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Curses, you&#x27;ve found the secret phase!&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;But finding it and solving it are quite different...&quot;</span>);</span><br><span class="line">    secret_phase();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Congratulations! You&#x27;ve defused the bomb!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当我们输入的字符串与<code>DrEvil</code>相同时进入道内部的一共函数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 <span class="title">secret_phase</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *line; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v1; <span class="comment">// ebx</span></span><br><span class="line">  line = read_line();</span><br><span class="line">  v1 = strtol(line, <span class="number">0LL</span>, <span class="number">10</span>);                   <span class="comment">// 将输入转化为long int</span></span><br><span class="line">  <span class="keyword">if</span> ( v1 - <span class="number">1</span> &gt; <span class="number">1000</span> )                          <span class="comment">// 输入数据小于1001</span></span><br><span class="line">    explode_bomb();</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)fun7((__int64)&amp;n1, v1) != <span class="number">2</span> )<span class="comment">// fun7返回值为2</span></span><br><span class="line">    explode_bomb();</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Wow! You&#x27;ve defused the secret stage!&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> phase_defused();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，核心的函数为<code>fun7</code>，点开进入：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">fun7</span><span class="params">(__int64 a1, __int64 a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">if</span> ( !a1 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">  <span class="keyword">if</span> ( *(_DWORD *)a1 &gt; (<span class="keyword">int</span>)a2 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span> * (<span class="keyword">unsigned</span> <span class="keyword">int</span>)fun7(*(_QWORD *)(a1 + <span class="number">8</span>), a2);</span><br><span class="line">  result = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( *(_DWORD *)a1 != (_DWORD)a2 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span> * (<span class="keyword">unsigned</span> <span class="keyword">int</span>)fun7(*(_QWORD *)(a1 + <span class="number">16</span>), a2) + <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看起来似乎又是一个递归调用，我们回到传入的数据<code>a1</code>中，经过修复后可以看到：</p>
<p><img src="https://s2.loli.net/2022/04/03/qWt9o6uyhXcwlCQ.png"></p>
<p>所以对应的<code>fun7</code>是一个二叉树，我们画出对应的树状图：</p>
<p><img src="https://s2.loli.net/2022/04/03/KqzQN2pmTVidJwn.png"></p>
<p>若访问到空节点，则返回值会出现<code>0xffffffff</code>，所以我们只能在树上（软件原因树的最右分枝未补全）的节点选择。通过代码我们知道，若从节点<code>n1</code>出发初始值为<code>0x24</code>，若改节点为右儿子则<code>a=2*a+1</code>、为左儿子则<code>a=a*2</code>。所以<code>0x16</code>、<code>0x14</code>节点都可以在到达根节点时返回<code>a=2</code>，输入任意一值即可通关。</p>

            <!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]-->
            <audio id="audio" loop="1" preload="auto" controls="controls" data-autoplay="false">
                <source type="audio/mpeg" src="">
            </audio>
            
                <ul id="audio-list" style="display:none">
                    
                        
                            <li title='0' data-url='http://link.hhtjim.com/163/425570952.mp3'></li>
                        
                    
                        
                            <li title='1' data-url='http://link.hhtjim.com/163/425570952.mp3'></li>
                        
                    
                </ul>
            
        </div>
        

    <div id='gitalk-container' class="comment link"
		data-enable='true'
        data-ae='true'
        data-ci='01ed89abee289d37f2f8'
        data-cs='51741e819059e2ea7ab6c6f3d0fa0ac631d1d975'
        data-r='equinox-shame.github.io'
        data-o='Equinox-shame'
        data-a='Equinox-shame'
        data-d='false'
    >查看评论</div>


        
    </div>
    
</div>


    </div>
</div>
</body>

<script src="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>


<script src="//lib.baomitu.com/jquery/1.8.3/jquery.min.js"></script>
<script src="/js/plugin.js"></script>
<script src="/js/typed.js"></script>
<script src="/js/diaspora.js"></script>


<link rel="stylesheet" href="/photoswipe/photoswipe.css">
<link rel="stylesheet" href="/photoswipe/default-skin/default-skin.css">


<script src="/photoswipe/photoswipe.min.js"></script>
<script src="/photoswipe/photoswipe-ui-default.min.js"></script>


<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>
    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <!--  Controls are self-explanatory. Order can be changed. -->
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>



<script type="text/x-mathjax-config">
    MathJax.Hub.Config({"HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"], linebreaks: { automatic:true }, EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50) },
        tex2jax: { inlineMath: [ ["$", "$"], ["\\(","\\)"] ], processEscapes: true, ignoreClass: "tex2jax_ignore|dno",skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']},
        TeX: {  noUndefined: { attributes: { mathcolor: "red", mathbackground: "#FFEEEE", mathsize: "90%" } }, Macros: { href: "{}" } },
        messageStyle: "none"
    });
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>




</html>
